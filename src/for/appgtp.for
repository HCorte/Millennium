C PROGRAM APPGTP
C  
C V06 15-jun-2000 OXK LN_EVNMASK moved here from LANEVN.DEF
C V05 17 Apr 1996 HXK Release of Finland for X.25, Telephone Betting, 
C			Instant Pass Thru Phase 1
C V04 30 Aug 1993 JWE Change form permanent to temporary mailboxs.
C V03 21 Jan 1993 DAB Initial Release
C  			Based on Netherlands Bible, 12/92, and Comm 1/93 update
C  			DEC Baseline
C V02 05-OCT-1990 MRM RELEASED FOR VAX
C V01 04-APR-1989 MBK TEST PROGRAM
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C This item is the property of GTECH Corporation, Providence, Rhode
C Island, and contains confidential and trade secret information. It
C may not be transferred from the custody or control of GTECH except
C as authorized in writing by an officer of GTECH. Neither this item
C nor the information it contains may be used, transferred,
C reproduced, published, or disclosed, in whole or in part, and
C directly or indirectly, except as expressly authorized by an
C officer of GTECH, pursuant to written agreement.
C
C Copyright 2000 GTECH Corporation. All rights reserved.
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C=======OPTIONS /CHECK=NOOVERFLOW
	PROGRAM APPGTP
	IMPLICIT NONE
C
	INCLUDE 'INCLIB:SYSPARAM.DEF'
	INCLUDE 'INCLIB:SYSEXTRN.DEF'
	INCLUDE 'INCLIB:LANCOM.DEF'
	INCLUDE 'INCLIB:X2TDBH.DEF'
	INCLUDE 'INCLIB:LANEVN.DEF'
        INCLUDE '($IODEF)'
        INCLUDE '($SSDEF)'
        INCLUDE '($SYSSRVNAM)'
C
        INTEGER*4       LN_EVNMASK              !BITMAP OF ALL EVENTS SET
C
	INTEGER*4 TIME, STATUS, I, FLGSTS, CMD, E, SSAP, DSAP, BUF
	INTEGER*4 ST, SAP, QUE, MYQUEUE, POOL, SMODE, TYPE, MLEN
	INTEGER*4 LENGTH, MMODE, NUM, DEL1, DEL2, SEQNUM, BLSIZ
	INTEGER*4 DOFF, ANS, BCOUNT, BLAST, SEQERR, GLOCNT
	INTEGER*4 DELAY, CFLAG, FEID, PROT
	CHARACTER*12 CSEQ
	INTEGER*4 CSEQI(3)
	EQUIVALENCE (CSEQ,CSEQI)
C
      COMMON MYQUEUE,BCOUNT(MAXSAP),BLAST(MAXSAP),SEQNUM(MAXSAP),GLOCNT
     *       , DELAY,MMODE(MAXSAP),PROT,CSEQ,FEID(MAXSAP),CFLAG(MAXSAP)
     *	       , TIME,DEL1,DEL2,SEQERR(MAXSAP)
C
	EXTERNAL GTSKTRAP
	LN_EVNMASK = 0
C
C CREATE THE COMMON EVENT FLAG CLUSTER.
C
        STATUS=SYS$ASCEFC(%VAL(LN_EVNTIMER),LN_EVNNAME,0,0)
        IF(.NOT.STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
C
C CREATE THE EVENT FLAG MASK OF EVENTS FOR WHICH
C TO TRAP ON.
C
        LN_EVNMASK = IBSET(LN_EVNMASK, MOD(APPMAIL,32))
        LN_EVNMASK = IBSET(LN_EVNMASK, MOD(LN_EVNTSK_FLAG(4),32))
C
C CLEAR ALL EVENT FLAGS.
C
        DO 22 I=1,LANMAXTSK
          STATUS=SYS$CLREF(%VAL(LN_EVNTSK_FLAG(I)))
22      CONTINUE
C
C SET THE MAIL FLAG FORCING MENU TO BE DISPLAYED.
C
        STATUS=SYS$SETEF(%VAL(APPMAIL))
C
C SETUP THE MAILBOX FOR INTERTASK MESSAGES.
C IF MAILBOX DOES NOT EXIST, CREATE IT.
C
        STATUS=SYS$ASSIGN(MBXGTP,LN_MESCHANNEL,,)
        IF(.NOT.STATUS) THEN
          STATUS=SYS$CREMBX(%VAL(0),LN_MESCHANNEL,,,
     *                     %VAL('FD00'X),,MBXGTP)
          IF(.NOT.STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
        ENDIF
C
C	CALL GETTIM(TIME)    !IN SECONDS FROM MIDNIGHT
C
C PLACE TASK IN TRAP WAIT STATE. NOTE: TASK WILL STILL
C SERVICE AST TRAPS WHILE WAITING FOR EVENT FLAGS TO BE SET.
C
5000    CONTINUE
        STATUS=SYS$WFLOR(%VAL(APPMAIL),%VAL(LN_EVNMASK))
        IF(.NOT.STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
C
C CHECK FOR MESSAGE TRAP (SET BY LMESTRAP).
C IF FLAG IS SET, START ANOTHER AST TO TRAP MAIL MESSAGES.
C
        STATUS=SYS$READEF(%VAL(APPMAIL),FLGSTS)
        IF(.NOT.STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
        IF(STATUS.EQ.SS$_WASSET) THEN
          STATUS=SYS$CLREF(%VAL(APPMAIL))
          IF(.NOT.STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
	  GOTO 10
        ELSE IF (STATUS.NE.SS$_WASCLR) THEN
          TYPE *,'APPGTP:INVALID MAIL EVENT FLAG'
        ENDIF
C
C CHECK FOR TASK TRAP FROM LANPRO.
C
        STATUS=SYS$READEF(%VAL(LN_EVNTSK_FLAG(4)),FLGSTS)
        IF(.NOT.STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
        IF(STATUS.EQ.SS$_WASSET) THEN
          STATUS=SYS$CLREF(%VAL(LN_EVNTSK_FLAG(4)))
          IF(.NOT.STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
          CALL GTSKTRAP(0)
          GOTO 5000
        ELSE IF (STATUS.NE.SS$_WASCLR) THEN
          TYPE *,'APPGTP:INVALID TASK EVENT FLAG'
        ENDIF
C
        GOTO 5000
C
C MENU OPTION.
C
10	CONTINUE
	TYPE*,'1.  CONNECT TO REMOTE SAP'
	TYPE*,'2.  DISCONNECT FROM REMOTE SAP'
	TYPE*,'3.  OPEN LOCAL SAP'
	TYPE*,'4.  CLOSE LOCAL SAP'
	TYPE*,'5   SEND LOOPBACK DATA AND GO INTO TRAP MODE'
	TYPE*,'6.  CHECK YOUR QUEUE'
	TYPE*,'7.  GO INTO TRAP MODE'
	TYPE*,'8.  RESET COUNTERS'
	TYPE*,'9.  SET LOOPBACK DELAY '
	TYPE*,'10. SET COMMUNICATION MODE'
	TYPE*,'11. SET FE ID'
C
	CALL INPNUM('ENTER COMMAND: ',CMD,1,13,E)
	IF(E.LT.0) GOTO 5000
C
	GOTO (100,200,300,400,500,600,700,800,900,1000,1100), CMD
C
100	CONTINUE
	CALL INPNUM('ENTER YOUR SAP: ',SSAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 10
	CALL INPNUM('ENTER DESTINATION SAP: ',DSAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 100
	CALL LANGETX(BUF,ST)
	IF (ST.EQ.2) THEN
	   TYPE*,'**** NO BUFFERS ****'
	   GOTO 10
	ENDIF
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCONREQ
	LANBUF(LANDATAF+1,BUF)=CCOMMAND
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANDATAF+4,BUF)=0
	LANBUF(LANOWN,BUF)=OWNEXEC
	CALL ABL(BUF,LANEXEC,ST)
	CALL QUEUE(LANTASKS(0),BUF,ST)
C
	GOTO 10
C
200	CONTINUE
	CALL INPNUM('ENTER YOUR SAP: ',SSAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 10
	CALL INPNUM('ENTER DESTINATION SAP: ',DSAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 100
	CALL LANGETX(BUF,ST)
	IF (ST.EQ.2) THEN
	   TYPE*,'**** NO BUFFERS ****'
	   GOTO 10
	ENDIF
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CDISREQ
	LANBUF(LANDATAF+1,BUF)=CCOMMAND
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP !         DSAP=0 LOCAL ONLY
	LANBUF(LANDATAF+4,BUF)=0
	LANBUF(LANOWN,BUF)=OWNEXEC
	CALL ABL(BUF,LANEXEC,ST)
	CALL QUEUE(LANTASKS(0),BUF,ST)
C
	GOTO 10
C
300	CONTINUE
	CALL INPNUM('ENTER LOCAL SAP: ',SAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 10
310	CONTINUE
	CALL INPNUM('ENTER QUEUE: ',QUE,1,LANMAXTSK,E)
	IF(E.LT.0) GOTO 300
	MYQUEUE=QUE
320	CONTINUE
	CALL INPNUM('ENTER SEND BUFFER POOL: ',POOL,1,LANBNUM,E)
	IF(E.LT.0) GOTO 310
330	CONTINUE
	CALL INPNUM('ENTER SYSTEM MODE: ',SMODE,1,3,E)
	IF(E.LT.0) GOTO 320
	CALL INPNUM('ENTER SYSTEM TYPE: ',TYPE,1,3,E)
	IF(E.LT.0) GOTO 330
C
	CALL LANGETX(BUF,ST)
	IF (ST.EQ.2) THEN
	   TYPE*,'**** NO BUFFERS ****'
	   GOTO 10
	ENDIF
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=COPEN
	LANBUF(LANDATAF+1,BUF)=CCOMMAND
	LANBUF(LANDATAF+2,BUF)=SAP
	LANBUF(LANDATAF+3,BUF)=QUE !         DSAP=0 LOCAL ONLY
	LANBUF(LANDATAF+4,BUF)=POOL
	LANBUF(LANDATAF+5,BUF)=SMODE
	LANBUF(LANDATAF+6,BUF)=TYPE
	LANBUF(LANOWN,BUF)=OWNEXEC
	CALL ABL(BUF,LANEXEC,ST)
	CALL QUEUE(LANTASKS(0),BUF,ST)
C
	GOTO 10
C
400	CONTINUE
	CALL INPNUM('ENTER LOCAL SAP: ',SAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 10
	CALL INPNUM('ENTER QUEUE: ',QUE,1,LANMAXTSK,E)
	IF(E.LT.0) GOTO 400
C
	CALL LANGETX(BUF,ST)
	IF (ST.EQ.2) THEN
	   TYPE*,'**** NO BUFFERS ****'
	   GOTO 10
	ENDIF
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCLOSE
	LANBUF(LANDATAF+1,BUF)=CCOMMAND
	LANBUF(LANDATAF+2,BUF)=SAP
	LANBUF(LANDATAF+3,BUF)=QUE !         DSAP=0 LOCAL ONLY
	LANBUF(LANOWN,BUF)=OWNEXEC
	CALL ABL(BUF,LANEXEC,ST)
	CALL QUEUE(LANTASKS(0),BUF,ST)
C
	GOTO 10
C
500	CONTINUE
	CALL INPNUM('ENTER YOUR SAP: ',SSAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 10
510	CONTINUE
	CALL INPNUM('ENTER DESTINATION SAP: ',DSAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 500
	MLEN=ETHLENMX-4-LANDATAB+1
	TYPE*,'MAXIMUM DATA LEN IS: ',MLEN
520	CONTINUE
	CALL INPNUM('ENTER DATA LENGTH: ',LENGTH,1,MLEN,E)
	IF(E.LT.0) GOTO 510
530	CONTINUE
	IF(MMODE(DSAP).EQ.2) THEN
         CALL INPNUM('ENTER NUMBER OF BUFFERS TO SEND: ',NUM,1,999999,E)
	   IF(E.LT.0) GOTO 520
	ELSE
	   NUM=9999999
	ENDIF
540	CONTINUE
	CALL INPNUM('ENTER DELAY 1 (NO BUFFERS): ',DEL1,0,999999,E)
	IF(E.LT.0) GOTO 530
C*550   CONTINUE
      CALL INPNUM('ENTER DELAY 2 (BETWEEN BUFFERS): ',DEL2,0,999999,E)
	IF(E.LT.0) GOTO 540
C
	QUE=QUESAP(SSAP)
590	CONTINUE
	CALL LANGETA(BUF,QUE,ST)
	IF (ST.EQ.2) THEN
	   TYPE*,'**** NO BUFFERS ****'
	   IF(DEL1.NE.0) CALL XWAIT(DEL1,1,ST)
	   GOTO 590
	ENDIF
	LANBUF(LANBTYP,BUF)=LTYPDATA
C
	LANBUF(LANDATAF,BUF)='TDBH'
	CALL NI4TOBUF4(X2TDBH_TDBH,LANBUF(LANDATAF,BUF),
     *                 X2TDBH_BLKCHK-1)
	CALL I4TOBUF2(SEQNUM(DSAP),LANBUF(LANDATAF,BUF),
     *                X2TDBH_BLKSEQ-1)
	CALL ISBYTE(DSAP,LANBUF(LANDATAF,BUF),
     *                X2TDBH_DSAP-1)
	CALL ISBYTE(SSAP,LANBUF(LANDATAF,BUF),
     *                X2TDBH_SSAP-1)
	CALL ISBYTE(0,LANBUF(LANDATAF,BUF),
     *                X2TDBH_FLAGS-1)
	BLSIZ=41
	CALL I4TOBUF2(BLSIZ,LANBUF(LANDATAF,BUF),
     *                X2TDBH_BLKSIZ-1)
C	BLTYP=255
	CALL ISBYTE(X2TDBHT_LOOPBACK,LANBUF(LANDATAF,BUF),
     *                X2TDBH_BLKTYP-1)
	DOFF=21
	CALL ISBYTE(DOFF,LANBUF(LANDATAF,BUF),
     *                X2TDBH_DATAOFF)
C
	CALL SNDLAN(SSAP,DSAP,BUF,LENGTH)
	SEQNUM(DSAP)=SEQNUM(DSAP)+1
	IF(SEQNUM(DSAP).GE.NUM) THEN
	   TYPE*,'BUFFERS SENT: ',SEQNUM(DSAP),' TO ',DSAP
	   GOTO 5000
	ENDIF
	IF(DEL2.NE.0) CALL XWAIT(DEL2,1,ST)
	GOTO 590
C
600	CONTINUE
	TYPE*,'CHECKING QUEUE'
C
	CALL INPNUM('ENTER QUEUE: ',QUE,1,LANMAXTSK,E)
	IF(E.LT.0) GOTO 10
C
	CALL WIMG(5,'HANDLE BY TASK TRAP [Y] OR DISPLAY [N] ')
	CALL YESNO(ANS)
C
	IF(ANS.EQ.1) THEN
	  CALL GTSKTRAP(0)
	ELSE
  	  CALL RTL(BUF,LANAPP(1,QUE),ST)
	  IF(ST.EQ.2) THEN
	     TYPE*,'QUEUE EMPTY'
	     GOTO 600
	  ENDIF
	  LANBUF(LANOWN,BUF)=OWNFAPPL
C
  	  TYPE*,'DF.....',LANBUF(LANDATAF,BUF)
	  TYPE*,'DF+1...',LANBUF(LANDATAF+1,BUF)
	  TYPE*,'DF+2...',LANBUF(LANDATAF+2,BUF)
	  TYPE*,'DF+3...',LANBUF(LANDATAF+3,BUF)
	  TYPE*,'DF+4...',LANBUF(LANDATAF+4,BUF)
	  TYPE*,'TYP....',LANBUF(LANBTYP,BUF)
C
	  IF(LANBUF(LANBTYP,BUF).EQ.LTYPDATA) THEN
	     TYPE*,'DATA LENGTH... ',LANBUF(LANDLEN,BUF)
C
	  ELSEIF(LANBUF(LANBTYP,BUF).EQ.LTYPCMD) THEN
	     TYPE*,'COMMAND'
C
	  ELSE
	     TYPE*,'BAD BUFFER'
	  ENDIF
C
	  CALL LANRELB(BUF)
	ENDIF
	GOTO 600
C
700	CONTINUE
	CALL GTSKTRAP(0)
	GOTO 5000
C
800	CONTINUE
	CALL INPNUM('ENTER SAP: ',SAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 800
	BCOUNT(SAP)=0
	BLAST(SAP)=0
	SEQNUM(SAP)=0
	SEQERR(SAP)=0
	GLOCNT=0
	GOTO 10
C
900	CONTINUE
	CALL INPNUM('ENTER LOOPBACK DELAY: ',DELAY,0,50000,E)
	IF(E.LT.0) GOTO 10
	GOTO 10
C
1000	CONTINUE
	CALL INPNUM('ENTER DSAP: ',DSAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 10
1010	CONTINUE
	CALL INPNUM('ENTER DIRECTION MODE:[1-ONE WAY 2-TWO WAY] ',
     *	             MMODE(DSAP),1,2,E)
	IF(E.LT.0) GOTO 1000
	CALL INPNUM('ENTER LOOP MODE:[0-DO NOT COPY 1-COPY BUFFER] ',
     *	             CFLAG(DSAP),0,1,E)
	IF(E.LT.0) GOTO 1010
	GOTO 1000
C
1100	CONTINUE
	CALL INPNUM('ENTER DSAP ',DSAP,1,MAXSAP,E)
	IF(E.LT.0) GOTO 10
	CALL INPNUM('ENTER ITS FE ID: ',FEID(DSAP),0,255,E)
	IF(E.LT.0) GOTO 1100
	GOTO 1100
C
	END
