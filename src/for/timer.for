C
C PROGRAM TIMER
C $Log:   GXAFXT:[GOLS]TIMER.FOV  $
C  
C     Rev 1.0   17 Apr 1996 15:34:02   HXK
C  Release of Finland for X.25, Telephone Betting, Instant Pass Thru Phase 1
C  
C     Rev 1.1   09 Aug 1993 15:49:06   SXH
C  Added RAVI V65 screening interval
C  
C     Rev 1.0   21 Jan 1993 17:51:04   DAB
C  Initial Release
C  Based on Netherlands Bible, 12/92, and Comm 1/93 update
C  DEC Baseline
C
C ** Source - timer.for **
C
C TIMER.FOR
C
C V07 15-MAR-10 RXK  CREATED A COMMAND TO RELEASE PASSIVE RESERVATIONS
C V06 26-FEB-01 CS   ADDED PASSIVE REPROCESSING QUEUE'S.
C V05 26-FEB-92 GCAN ADDED TV NEWS MESSAGE UPDATE.
C V04 03-DEC-91 GCAN ADDED CODE TO RELEASE UNSPRO WHEN NEEDED.
C V03 09-MAY-91 MP   ADDED CALL TO SNIF_AND_WRKSET
C V02 14-MAR-91 MTK  INITIAL RELEASE FOR MARYLAND
C V01 01-AUG-90 XXX  RELEASED FOR VAX
C
C
C
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C This item is the property of GTECH Corporation, Providence, Rhode
C Island, and contains confidential and trade secret information. It
C may not be transferred from the custody or control of GTECH except
C as authorized in writing by an officer of GTECH. Neither this item
C nor the information it contains may be used, transferred,
C reproduced, published, or disclosed, in whole or in part, and
C directly or indirectly, except as expressly authorized by an
C officer of GTECH, pursuant to written agreement.
C
C Copyright 1991 GTECH Corporation. All rights reserved.
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C=======OPTIONS /CHECK=NOOVERFLOW
	PROGRAM TIMER
	IMPLICIT NONE
C
	INCLUDE 'INCLIB:SYSPARAM.DEF'
	INCLUDE 'INCLIB:SYSEXTRN.DEF'
	INCLUDE 'INCLIB:GLOBAL.DEF'
	INCLUDE 'INCLIB:TASKID.DEF'
	INCLUDE 'INCLIB:CONCOM.DEF'
	INCLUDE 'INCLIB:PROCOM.DEF'
	INCLUDE 'INCLIB:QUECOM.DEF'
C
	INTEGER*4   LNGDEL,MINUTE,MAXUNS,SECOND
	PARAMETER   (LNGDEL=125)	!LONG DELAY (125 MSECS)
	PARAMETER   (MINUTE=480)	!1 MINUTE
	PARAMETER   (SECOND=8)  	!1 SECOND
	PARAMETER   (MAXUNS= 02)	!Max # Unsolicited Tasks to be Released.
C
	INTEGER*4   I, ST, DELAY, RTIME
	INTEGER*4   CBUF(CDLEN)
C
	INTEGER*4   LOGLOP/0/, CHKLOP/0/, PASLOP/0/
C
	INTEGER*4   BUF			!Procom Buffer #.
	INTEGER*4   LOPTIM		!Time to Release UNSPRO after in ms.
	INTEGER*4   LOOPTIME(MAXUNS)	!Loop Timers.
	INTEGER*4   PTAB(MAXUNS)	!Parameter Number Table.
C
	DATA	    PTAB/JAKUPD,TVNUPD/
C
	CALL COPYRITE
C V02
	CALL SNIF_AND_WRKSET
C
C
C RUN EVERY 125 MILLISECONDS. (1/8 SECOND)
C
	DELAY=LNGDEL
	SYSTIM=1
	P(TIMER_THRLOP)=0
C
C SET / CLEAR VARIABLES
C
	LOPTIM = 0
	CALL FASTSET(0,LOOPTIME,MAXUNS)
C
10	CONTINUE
	CALL XWAIT(DELAY,1,ST)
C
C     IF SYSTEM IS IN TEST MODE TIMER IS RUN 5 TIMES AS OFTEN
C     AND TIMER LOGIC SHOULD BE EXECUTED ONLY 1 OF 5 TIMES
C
	SYSTIM=SYSTIM+DELAY             !MAY OVERFLOW AFTER 9 HOURS
	LOGLOP=LOGLOP+1
	CHKLOP=CHKLOP+1
        PASLOP=PASLOP+1
	P(TIMER_THRLOP)=P(TIMER_THRLOP)+1
C
C CHECK IF TIME TAKE THRPUT MEASUREMENT
C
	IF(P(TIMER_THRLOP).EQ.MINUTE) THEN
	  P(TIMER_THRLOP)=0
	  DO 20 I=1,MAXPER
	  PERFRM(3,I)=PERFRM(1,I)-PERFRM(2,I)
	  PERFRM(2,I)=PERFRM(1,I)
20	  CONTINUE
	ENDIF
C
C CHECK IF TIME TO PERFORM CHECKPOINT
C ONLY IF PREVIOUS CHECKPOINT FINISHED AND GAME NOT FROZEN
C
	IF(P(SYSTYP).NE.LIVSYS)CHKLOP=0
        IF(CHKLOP.GE.P(CHKTIM).AND.P(CHKFLG).EQ.0.AND.
     *     P(CMDFRZ).EQ.0)THEN
	  CHKLOP=0
	  CBUF(1)=1
	  CBUF(3)=TCGEN
	  CBUF(6)='SYS '
	  CALL QUECMD(CBUF,ST)
	ENDIF
C
C CHECK IF TIME TO RELEASE EPASSIVE RESERVATIONS
C
        IF(P(PMAXRTM).GT.0) THEN
           IF(PASLOP.GT.P(PMAXRTM)*SECOND) THEN
              PASLOP = 0
              IF(P(SYSTYP).EQ.LIVSYS) THEN
                 CALL GETTIM(RTIME)    
                 CBUF(1)= 9
                 CBUF(2)= RTIME
                 CBUF(3)= TCPAS
                 CBUF(6)='SYS '      
                 CALL QUECMD(CBUF,ST)
              ENDIF
           ENDIF
        ENDIF
C
C CHECK IF TIME TO ACTIVATE LOGGER
C
	IF(LOGLOP.GE.P(LOGTIM)) THEN
	  LOGLOP=0
C	  CALL RELSE(TSKNAM(LOG),ST)
C	  IF(P(TAPESW).NE.0) CALL RELSE(TSKNAM(TAP),ST)
C	  IF(ACTTSK(RPC).NE.0) CALL RELSE(TSKNAM(RPC),ST)
C	  IF(REPVQUE(2)-REPVQUE(3).NE.0) CALL RELSE(TSKNAM(VAL),ST)
C
C CHECK FOR PASSIVE GAME (VALIDATIONS AND RETURN TICKETS)
C
C	  IF  (REPQUEPAS(2,RQPASPRO)-REPQUEPAS(3,RQPASPRO).NE.0)
C     *	      CALL RELSE(TSKNAM(PST),ST)
C	  IF  (REPQUEPAS(2,RQPASVAL)-REPQUEPAS(3,RQPASVAL).NE.0)
C     *	      CALL RELSE(TSKNAM(PSV),ST)

	ENDIF
C                                                                               
C
C LOOP THROUGH ALL UNS TASKS AND CHECK IF TIME TO ACTIVATE UNSPRO
C
	DO 200 I = 1,MAXUNS
C
C FIGURE OUT TIME TO WAIT AND CHECK IF LOOPS ARE ENABLED
C
	   LOPTIM = P(PTAB(I)) * 1000          !In ms.
	   IF(P(SYSTYP).NE.LIVSYS) LOPTIM = 0  !Only run if Primary System.
	   IF(LOPTIM.LE.0) GOTO 200
C
C INCREMENT LOOP TIMERS AND CHECK IF TIME TO RELEASE UNSPRO
C
	   LOOPTIME(I) = LOOPTIME(I) + DELAY
	   IF(LOOPTIME(I).GE.LOPTIM) THEN
	      LOOPTIME(I) = 0
C
C GET BUFFER , IF ERROR ON GETTING BUFFER DO NOT CLEAR TIMER
C
	      CALL GETBUF(BUF)
	      IF(BUF.LE.0) GOTO 200
C
C BUILD DUMMY BUFFER AND QUEUE TO UNSPRO
C
	      HPRO(TRCODE,BUF) = TYPUNS
	      HPRO(INPLEN,BUF) = 8
	      PRO(INPTAB+0,BUF) = -1             !Type Field
	      PRO(INPTAB+2,BUF) = PTAB(I)	 !Parameter Number
	      CALL QUETRA(UNS,BUF)
C
C RELEASE UNSPRO
C
	      CALL RELSE(TSKNAM(UNS),ST)
C
	   ENDIF
C
200	CONTINUE	   	
C
C IF END OF DAY STOP, ELSE GO BACK TO WAIT STATE
C
	IF(P(LOGSTP).EQ.0) GOTO 10
	CALL GSTOP(GEXIT_SUCCESS)
	END
