C
C SUBROUTINE WIN_PSTGDF
C
C V09 04-JUN-2001 ANG Fix for offline sales
C V08 03-DEc-2000 UXN Totogolo added.
C V07 27-APR-2000 UXN Fix for setting WINCAN status for VAKIO. 
C V06 20-DEC-1999 OXK Postponed draws status changed to WINCAN.
C V05 15-DEC-1999 UXN MULTIWIN CHANGES.
C V04 27-APR-1999 RXK If multiwinsel then wait until the completion of Ravi 
C                     winsel and post Kicker sales of Ravi here.
C V03 03-OCT-1993 HXK Keep track of Joker winners as there is now more than one
C                     Joker winsel on a draw night. (It's an improvement!)
C V02 15-SEP-1993 HXK Fix for Viking Winsel balancing
C V01 22-AUG-1993 GXA Released for Finland Dec Conversion / Oddset.
C  
C
C SUBROUTINE TO UPDATE GAME FILES WITH DRAW INFORMATION
C
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C This item is the property of GTECH Corporation, Providence, Rhode
C Island, and contains confidential and trade secret information. It
C may not be transferred from the custody or control of GTECH except
C as authorized in writing by an officer of GTECH. Neither this item
C nor the information it contains may be used, transferred,
C reproduced, published, or disclosed, in whole or in part, and
C directly or indirectly, except as expressly authorized by an
C officer of GTECH, pursuant to written agreement.
C
C Copyright 1999 GTECH Corporation. All rights reserved.
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C=======OPTIONS /CHECK=NOOVERFLOW
	SUBROUTINE WIN_PSTGDF
	IMPLICIT NONE
C
	INCLUDE 'INCLIB:SYSPARAM.DEF'
	INCLUDE 'INCLIB:SYSEXTRN.DEF'
	INCLUDE 'INCLIB:GLOBAL.DEF'
	INCLUDE 'INCLIB:WINCOM.DEF'
	INCLUDE 'INCLIB:CONCOM.DEF'
	INCLUDE 'INCLIB:KIKCOM.DEF'
	INCLUDE 'INCLIB:DLTREC.DEF'
	INCLUDE 'INCLIB:DSPREC.DEF'
	INCLUDE 'INCLIB:DTGREC.DEF'
	INCLUDE 'INCLIB:DKKREC.DEF'
	INCLUDE 'INCLIB:GTNAMES.DEF'
	INCLUDE 'INCLIB:STOPCOM.DEF'
	INCLUDE 'INCLIB:MULNAM.DEF'

	INTEGER*4 FDB(7), GAM, DAY, ST, K, GNUM, DRAW, GIND, I

        INTEGER*4 GTYP                  !game type

	INTEGER*4 FRCS			!# of Fractions.
	INTEGER*4 BNSOFF		!bonus # offset.
C
C LOTTO GAMES
C
	DO 1000 GIND=1,NUMLTO
	DRAW=LLTDRW(GIND)
	GNUM=GTNTAB(TLTO,GIND)
	IF(DRAW.LT.1) GOTO 1000
	IF(LTDELAY(GIND).EQ.2) THEN 
	   IF(STOPMOD.EQ.WINMULTI) DRWSTS(MLWININD,GNUM)=WINCAN
	   GOTO 1000
	ENDIF
	WRITE(6,900) IAM(),(GFNAMES(K,GNUM),K=1,5)
	CALL OPENW(3,GFNAMES(1,GNUM),4,0,0,ST)
	CALL IOINIT(FDB,3,DLTSEC*256)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),1,ST,0)
	CALL READW(FDB,DRAW,DLTREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),2,ST,DRAW)
C
C COMPARE WINSEL SALES FIGURES WITH DAILY SALES FIGURES
C
C LAST POSITION, WE USE FOR OFFLINE SALES (MULTI DRAW)
C
	DO 100 DAY=1,LTGENT
	IF(DAY.EQ.LTGENT.OR.DAY.EQ.2) THEN
	    LLTSAL(DAY,GIND) = LLTSAL(DAY,GIND) + DLTSAL(DAY)
	    GOTO 100
	ENDIF

	IF(DLTSAL(DAY).NE.LLTSAL(DAY,GIND).AND.DAY.NE.2) THEN
	  WRITE(6,901) IAM(),GTNAMES(TLTO),GIND,DAY,
     *	               CMONY(DLTSAL(DAY),12,BETUNIT),
     *		       CMONY(LLTSAL(DAY,GIND),12,BETUNIT)
	  CALL GPAUSE
	ENDIF
100	CONTINUE
C
C RECALCULATE SHARES FOR ONE FRACTION
C
	FRCS = MAXFRC(GNUM)
	IF(FRCS.NE.0) THEN
	   DO BNSOFF = 1,2
	      DO I = 1,LTGDIV
	         LLTSHR(I,BNSOFF,GIND) = LLTSHR(I,BNSOFF,GIND) / FRCS
	      END DO
	   END DO
	ENDIF
C
	CALL GAMLOG(TLTO,GIND,DLTREC,LLTSTS)
	CALL WRITEW(FDB,DRAW,DLTREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),3,ST,DRAW)
C
        IF(STOPMOD.EQ.WINMULTI) DRWSTS(MLWININD,GNUM)=WINSOK
C
C UPDATE ADVANCE SALES FOR NEXT DRAW
C
	DRAW=DRAW+1
	CALL READW(FDB,DRAW,DLTREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),2,ST,DRAW)
	DLTSAL(1)=LADVSAL(GIND)
	CALL WRITEW(FDB,DRAW,DLTREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),3,ST,DRAW)
	CALL CLOSEFIL(FDB)
1000	CONTINUE
C
C SPORTS GAMES
C
	DO 2000 GIND=1,NUMSPT
	DRAW=LSPDRW(GIND)
	GNUM=GTNTAB(TSPT,GIND)
	IF(DRAW.LT.1) GOTO 2000
	IF(SPDELAY(GIND).EQ.2) THEN
           IF(STOPMOD.EQ.WINMULTI) THEN
                IF(DRWGAM(MLWININD,GNUM).GT.0) THEN
                   DRWSTS(MLWININD,GNUM)=WINCAN
                ENDIF
           ENDIF
	   GOTO 2000
	ENDIF
	WRITE(6,900) IAM(),(GFNAMES(K,GNUM),K=1,5)
	CALL OPENW(3,GFNAMES(1,GNUM),4,0,0,ST)
	CALL IOINIT(FDB,3,DSPSEC*256)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),1,ST,0)
	CALL READW(FDB,DRAW,DSPREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),2,ST,DRAW)
C
C COMPARE WINSEL SALES FIGURES WITH DAILY SALES FIGURES
C
	DO 1100 DAY=1,SPGENT
	IF(DAY.EQ.2) THEN
	    LSPSAL(DAY,GIND) = LSPSAL(DAY,GIND) + DSPSAL(DAY)
	    GOTO 1100
	ENDIF

	IF(DSPSAL(DAY).NE.LSPSAL(DAY,GIND).AND.DAY.NE.2) THEN
	  WRITE(6,901) IAM(),GTNAMES(TSPT),GIND,DAY,
     *	               CMONY(DSPSAL(DAY),12,BETUNIT),
     *		       CMONY(LSPSAL(DAY,GIND),12,BETUNIT)
	  CALL GPAUSE
	ENDIF
1100	CONTINUE
C
C RECALCULATE SHARES FOR ONE FRACTION
C
	FRCS = MAXFRC(GNUM)
	IF(FRCS.NE.0) THEN
	   DO I = 1,SPGDIV
	      LSPSHR(I,GIND) = LSPSHR(I,GIND) / FRCS
	   END DO
	ENDIF
C
	CALL GAMLOG(TSPT,GIND,DSPREC,LSPSTS)
	CALL WRITEW(FDB,DRAW,DSPREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),3,ST,DRAW)
C
        IF(STOPMOD.EQ.WINMULTI) DRWSTS(MLWININD,GNUM)=WINSOK
C
C UPDATE ADVANCE SALES FOR NEXT DRAW
C
	DRAW=DRAW+1
	CALL READW(FDB,DRAW,DSPREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),2,ST,DRAW)
	DSPSAL(1)=SADVSAL(GIND)
	CALL WRITEW(FDB,DRAW,DSPREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),3,ST,DRAW)
	CALL CLOSEFIL(FDB)
2000	CONTINUE
C
C TOTOGOLO GAMES
C
	DO 2500 GIND=1,NUMTGL
	DRAW=LTGDRW(GIND)
	GNUM=GTNTAB(TTGL,GIND)
	IF(DRAW.LT.1) GOTO 2500
	IF(TGDELAY(GIND).EQ.2) THEN
           IF(STOPMOD.EQ.WINMULTI) THEN
                IF(DRWGAM(MLWININD,GNUM).GT.0) THEN
                   DRWSTS(MLWININD,GNUM)=WINCAN
                ENDIF
           ENDIF
	   GOTO 2500
	ENDIF
	WRITE(6,900) IAM(),(GFNAMES(K,GNUM),K=1,5)
	CALL OPENW(3,GFNAMES(1,GNUM),4,0,0,ST)
	CALL IOINIT(FDB,3,DTGSEC*256)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),1,ST,0)
	CALL READW(FDB,DRAW,DTGREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),2,ST,DRAW)
C
C COMPARE WINSEL SALES FIGURES WITH DAILY SALES FIGURES
C
	DO 1500 DAY=1,TGGENT
	IF(DAY.EQ.2) THEN
	    LTGSAL(DAY,GIND) = LTGSAL(DAY,GIND) + DTGSAL(DAY)
	    GOTO 1500
	ENDIF

	IF(DTGSAL(DAY).NE.LTGSAL(DAY,GIND).AND.DAY.NE.2) THEN
	  WRITE(6,901) IAM(),GTNAMES(TTGL),GIND,DAY,
     *	               CMONY(DTGSAL(DAY),12,BETUNIT),
     *		       CMONY(LTGSAL(DAY,GIND),12,BETUNIT)
	  CALL GPAUSE
	ENDIF
1500	CONTINUE
C
C RECALCULATE SHARES FOR ONE FRACTION
C
	FRCS = MAXFRC(GNUM)
	IF(FRCS.NE.0) THEN
	   DO I = 1,TGGDIV
	      LTGSHR(I,GIND) = LTGSHR(I,GIND) / FRCS
	   END DO
	ENDIF
C
	CALL GAMLOG(TTGL,GIND,DTGREC,LTGSTS)
	CALL WRITEW(FDB,DRAW,DTGREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),3,ST,DRAW)
C
        IF(STOPMOD.EQ.WINMULTI) DRWSTS(MLWININD,GNUM)=WINSOK
C
C UPDATE ADVANCE SALES FOR NEXT DRAW
C
	DRAW=DRAW+1
	CALL READW(FDB,DRAW,DTGREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),2,ST,DRAW)
	DTGSAL(1)=TGADVSAL(GIND)
	CALL WRITEW(FDB,DRAW,DTGREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),3,ST,DRAW)
	CALL CLOSEFIL(FDB)
2500	CONTINUE
C
C
C KICKER GAMES
C
	DO 3000 GIND=1,NUMKIK
	DRAW=LKKDRW(GIND)
	IF(DRAW.LT.1) GOTO 3000    !if not a kicker winsel day
	GNUM=GTNTAB(TKIK,GIND)
C
	WRITE(6,900) IAM(),(GFNAMES(K,GNUM),K=1,5)
	CALL OPENW(3,GFNAMES(1,GNUM),4,0,0,ST)
	CALL IOINIT(FDB,3,DKKSEC*256)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),1,ST,0)
	CALL READW(FDB,DRAW,DKKREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),2,ST,DRAW)
C
C COMPARE WINSEL SALES FIGURES WITH DAILY SALES FIGURES
C
C LAST POSITION, WE USE FOR OFFLINE SALES (MULTI DRAW)

	DO 2100 DAY=1,LTGENT
	DO 2100 GAM=1,MAXGAM

        GTYP=GNTTAB(GAMTYP,GAM)
        IF(STOPMOD.EQ.WINMANUAL) THEN
           IF(GTYP.NE.TLTO.AND.GTYP.NE.TSPT.AND.GTYP.NE.TKIK.AND.
     *        GTYP.NE.TTGL) GOTO 2100
        ENDIF

	IF (DAY.EQ.LTGENT.OR.DAY.EQ.2) THEN
	    LKKSAL(DAY,GAM,GIND) = LKKSAL(DAY,GAM,GIND) + DKKSAL(DAY,GAM)
	    GOTO 2100
	ENDIF

	IF(DKKSAL(DAY,GAM).NE.LKKSAL(DAY,GAM,GIND).AND.DAY.NE.2) THEN
	  WRITE(6,902) IAM(),GTNAMES(TKIK),GIND,DAY,GAM
     	  WRITE(6,903) CMONY(DKKSAL(DAY,GAM),12,BETUNIT),
     *		       CMONY(LKKSAL(DAY,GAM,GIND),12,BETUNIT)
	  CALL GPAUSE
	ENDIF
2100	CONTINUE
C
C RECALCULATE SHARES FOR ONE FRACTION
C
	FRCS = MAXFRC(GNUM)
	IF(FRCS.NE.0) THEN
	   DO I = 1,KIGDIV
	      LKKSHR(I,GIND) = LKKSHR(I,GIND) / FRCS
              LKKSHR(I,GIND) = LKKSHR(I,GIND) + DKKSHR(I)
	   END DO
	ENDIF

	CALL GAMLOG(TKIK,GIND,DKKREC,LKKSTS)
	CALL WRITEW(FDB,DRAW,DKKREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),3,ST,DRAW)
C
        IF(STOPMOD.EQ.WINMULTI) DRWSTS(MLWININD,GNUM)=WINSOK
C
C UPDATE ADVANCE SALES FOR NEXT DRAW
C
	DRAW=DRAW+1
	CALL READW(FDB,DRAW,DKKREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),2,ST,DRAW)
C
	DO 2200 GAM=1,MAXGAM
	IF(DKKSAL(1,GAM).EQ.0) THEN
	  DKKSAL(1,GAM)=KADVSAL(GAM,GIND)
	ENDIF
2200	CONTINUE
C
	CALL WRITEW(FDB,DRAW,DKKREC,ST)
	IF(ST.NE.0) CALL FILERR(GFNAMES(1,GNUM),3,ST,DRAW)
	CALL CLOSEFIL(FDB)
3000	CONTINUE
	RETURN
C
C
900	FORMAT(1X,A,' Posting winsel data to ',5A4)
901	FORMAT(1X,A,1X,A8,I1,'   sales discrepancy for index ',I4,/,
     *	       20X,'Daily posting ',A12,' Winsel posting ',A12)
902     FORMAT(1X,A,A8,I1,'   sales discrepancy for index ',I4,' Gam ',I2)
903	FORMAT(20X,'Daily posting ',A12,' Winsel posting ',A12)
904	FORMAT(1X,A,1X,'Waiting for completion of ',A8)

9021    FORMAT(1X,A,A8,I1,'   old sales discrepancy for game ',I4)
	END
