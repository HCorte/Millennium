C
C SUBROUTINE TIMETRAP
C $Log:   GXAFXT:[GOLS]TIMETRAP.FOV  $
C  
C     Rev 1.0   17 Apr 1996 15:34:10   HXK
C  Release of Finland for X.25, Telephone Betting, Instant Pass Thru Phase 1
C  
C     Rev 1.0   21 Jan 1993 17:51:10   DAB
C  Initial Release
C  Based on Netherlands Bible, 12/92, and Comm 1/93 update
C  DEC Baseline
C
C ** Source - netlog.for;1 **
C
C
C++++++++++++++++++++++++++++++++++++++++++++++++++++++*
C
C     TIMER TRAP
C
C=======OPTIONS /CHECK=NOOVERFLOW
	SUBROUTINE TIMETRAP(INDEX)
	IMPLICIT NONE
C
	INCLUDE 'INCLIB:SYSPARAM.DEF'
	INCLUDE 'INCLIB:SYSEXTRN.DEF'
	INCLUDE 'INCLIB:GLOBAL.DEF'
	INCLUDE 'INCLIB:DESNET.DEF'
	INCLUDE 'INCLIB:NETDCN.DEF'
C
	INTEGER*4 INDEX
	INTEGER*4 INIERROR, WRGO, RND, RDGO, XOPT, ST, READDELAY
	INTEGER*4 FREE, NOBUFFER, OFFSET, DEST, TOMASTER, FC, OFF
	INTEGER*4 WAY, STARTUP, BUF, ERROR, NODE, LUN, IOTIME
	INTEGER*4 REVERSEREAD, REVERSEWRITE, STARTED
C
	COMMON /INIT/ STARTED(2,NETSYS,NUMWAY)       !I/O MODE
     *	             ,REVERSEWRITE(NETLUN)    !DO NOT START CONTINUES READ
     *	             ,REVERSEREAD(NETLUN)    !DO NOT START CONTINUES READ
     *	             ,IOTIME(2,NETSYS,NUMWAY)       !TIME I/O STARTED
	INTEGER*4 PBLOCK(7,NETNUM+1,NETLUN)  !I/O PROCEED PARAMETR BLK
	LOGICAL FILE,SSA
C
C
	INTEGER*4 SSAINI(NETLUN)    !SSA INITIALIZED FLAG
	COMMON /INISSA/ SSAINI
C
	INTEGER*4 RBLOCK(7,NETLUN),TBLK(7,NETLUN) !READ AND TIMER TRAP
	INTEGER*4 INIBLK(8,NETLUN)
	COMMON /PBLOCKS/ RBLOCK,PBLOCK,TBLK,INIBLK
	INTEGER*4 TBLOCK(7)
	INTEGER*4 TEMP,I
	INTEGER*2 HTEMP(2)
	EQUIVALENCE (TEMP,HTEMP)
C
C MOVE DATA FROM TIMER TRAP TO ROUTINE.
C
	TYPE *,IAM(),CHAR(7),'***** TIMER TRAP *******'
	DO 1 I=1,7
	  TBLOCK(I)=ND_PBLOCK(I,INDEX)
1	CONTINUE
C
	LUN=TBLOCK(3)
	NODE=NETASSN(LUN)
	ERROR=TBLOCK(4)
	BUF=TBLOCK(5)                        !GET BUFFER #
	STARTUP=TBLOCK(6)
	WAY=TBLOCK(7)
C
	IF (NODE.LE.0.OR.NODE.GT.NETSYS.OR.
     *	    LUN.LE.0.OR.LUN.GT.NETLUN.OR.
     *	    WAY.LE.0.OR.WAY.GT.NUMWAY) THEN
	   TYPE 900,TBLOCK
900	   FORMAT(' Invalid pblock in a timer trap ',7(1X,Z8))
	   TYPE *,'Netassn ',NETASSN
	   RETURN
	ENDIF
	TEMP=IAND(NETDEV(1,LUN),'FFFFFF00'X)
	SSA=TEMP.EQ.'53534100'X   !.EQ.'SSA'
C
	IF (STARTUP.NE.0)THEN !ER BRINGING SSA UP
	  INIBLK(8,LUN)=0            !FLAG TO RESTART GOTIMER ON INIT
C
	  IF (NETROUT(NODE,WAY).NE.ROUACT.OR.  !IF NODE NOT ACTIVE
     *	      SSAINI(LUN).EQ.0)   THEN     !ALREADY INITED
	      RETURN
	  ENDIF
C                                                  ;OR PPI
	  DO 10, OFF=1,6
	  TBLOCK(OFF)=0
10	  CONTINUE
	  FC=BUF
	  TBLOCK(7)=WAY
	  CALL SYSIO(TBLOCK,FC,LUN,0,0,0,0)
	  RETURN
	ENDIF
C
	IF (BUF.NE.0) THEN      !FOR WRITES
	  TOMASTER=0
	  DEST=NETBUF(PDEST,BUF)
	  IF (DEST.NE.0) THEN
	    IF (NETSTAT(DEST,WAY).EQ.NSTASEC) TOMASTER=-1
	  ENDIF
	   FILE=NETBUF(MODE,BUF).EQ.FILMD.OR.NETBUF(MODE,BUF).EQ.CMDMD
	1   .AND.NETBUF(HDRSIZ+1,BUF).EQ.RESYNC.OR.TOMASTER.NE.0.OR.
	2   NETBUF(MODE,BUF).EQ.ACKMD
	ENDIF
C
C
	IF (NETROUT(NODE,WAY).NE.ROUACT.AND.SSAINI(LUN).EQ.0) THEN
	  IF (BUF.NE.0) THEN
	    CALL FREEBUF(BUF)       !FREE THIS BUFFER
	    OFFSET=TRNMD
	    IF (FILE) OFFSET=FILMD
	    IF (STARTED(OFFSET,NODE,WAY).NE.0) THEN
	       NETIO(OFFSET,WAY)=MAX0(NETIO(OFFSET,WAY)-1,0)
C**	       NETIO(OFFSET,WAY)=0
	       STARTED(OFFSET,NODE,WAY)=0
	    ENDIF
	    CALL QUETRAP(-2)        !KICK QUETRAP ROUTINE 4/30
	  ENDIF
	  REVERSEWRITE(LUN)=0
	  REVERSEREAD(LUN)=0
	  RETURN
	ENDIF
	NETTIM(NODE,WAY)=NETTIMER              !MARK LAST I/O
	NOBUFFER='0000C081'X
	IF (BUF.EQ.0) THEN           !IF REMOTE READ
	   IF(NETROUT(NODE,WAY).NE.ROUACT) THEN
	      CALL QUETRAP(-2)     !MK 4/30
	      RETURN
	   ENDIF
C
	   TEMP=NETFREE(1,WAY)
	   FREE=HTEMP(2)
	   IF (FREE.LT.5.AND.ERROR.EQ.NOBUFFER) THEN  !LESS THAN 5 BUFS
C                                   ;AVAILABLE, JUST ARBITRARY #
C                                   ;IS THIS GOOD PROGRAMING PRACTICE?
C
	      READDELAY=300
	      TBLOCK(7)=WAY
	      CALL GOTIMER(TBLOCK,READDELAY,ST) !GENERATE NEXT TRAP
	      RETURN
	   ENDIF
C
	   REVERSEREAD(LUN)=0
C***     IF (REVERSEWRITE(LUN).EQ.0) THEN
	   IF (REVERSEWRITE(LUN).EQ.0.AND.READIOCHK(LUN).EQ.0) THEN
C
	     IF(SSA) THEN
	       IF(SSAINI(LUN-1).NE.0) RETURN   !6/15/87 MK
	     ENDIF
C
	     XOPT=1
	     RDGO='00000041'X
	      RBLOCK(7,LUN)=WAY
C**	     READIOCHK(LUN)=READIOCHK(LUN)+1
	     CALL REMIO(RBLOCK(1,LUN),RDGO,LUN,NETFREE(1,WAY)
     *	           ,NETIODONE(1,LUN),XOPT,4*(NETLEN-NCNLEN)-2)
	   ENDIF
C
	ELSE                        !FOR WRITE
C
	    XOPT=BUF
	    RND=0
	    WRGO='20'X
C
	    PBLOCK(7,BUF,LUN)=WAY
	    SNDIOCHK(LUN)=SNDIOCHK(LUN)+1
	      IF (SSAINI(LUN).EQ.0) THEN
		  CALL SYSIO(PBLOCK(1,BUF,LUN),WRGO,LUN,NETBUF(NCNLEN+1,BUF),
     *			       (NETBUF(NEXT,BUF)-NCNLEN)*4,RND,XOPT)
C
	      ELSE          !TRY TO DO SUTO WRITE TRAP
		  INIERROR='0000FFF0'X
		  TEMP=0
		  HTEMP(1)=LUN
		  HTEMP(1)='2000'X+LUN    !WRITE ON LOGICAL UNIT
		  PBLOCK(1,BUF,LUN)=IOR(TEMP,INIERROR)
		  PBLOCK(2,BUF,LUN)=BUF
		  CALL IOTRAP(PBLOCK(1,BUF,LUN))
	      ENDIF
C
C
      	    IF(FILE.AND.ERROR.EQ.NOBUFFER) IOTIME(FILMD,NODE,WAY)=
	1	    NETTIMER
	      NOBUFFER='00009081'X
      	    IF(FILE.AND.ERROR.EQ.NOBUFFER) IOTIME(FILMD,NODE,WAY)=
	1	    NETTIMER
C
C
	ENDIF
	RETURN
	END
