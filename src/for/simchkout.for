C
C SUBROUTINE SIMCHKOUT
C $Log:   GXAFXT:[GOLS]SIMCHKOUT.FOV  $
C  
C     Rev 1.0   17 Apr 1996 15:05:56   HXK
C  Release of Finland for X.25, Telephone Betting, Instant Pass Thru Phase 1
C  
C     Rev 1.0   21 Jan 1993 17:37:44   DAB
C  Initial Release
C  Based on Netherlands Bible, 12/92, and Comm 1/93 update
C  DEC Baseline
C
C ** Source - encpro.for **
C
C
C**********************************************************************
C
C	CHECK IF THIS IS SIMULATED TRANSACTION, IF IT IS SOME STATS
C	WILL BE DONE, TRANSACTION WILL SENT TO SIMULATION OPUTPUT
C	AND LOOPBACK RESPONSE WILL BE SENT TO TERMINAL
C
C	CALL SIMCHKOUT(OUTPUT_BUF,XREF_BUF)
C	IN:
C	OUTPUT_BUF  -	BUFFER # RECEIVED FROM GAME
C	XREF_BUF    -	ORIGINAL BUFFER AS IT CAME FROM COMM
C			(SHOULD BE NON 0)
C
C=======OPTIONS /CHECK=NOOVERFLOW
	SUBROUTINE SIMCHKOUT(OUTPUT_BUF,XREF_BUF)
	IMPLICIT NONE
C
	INCLUDE 'INCLIB:SYSPARAM.DEF'
	INCLUDE 'INCLIB:SYSEXTRN.DEF'
	INCLUDE 'INCLIB:GLOBAL.DEF'
	INCLUDE 'INCLIB:CONCOM.DEF'
	INCLUDE 'INCLIB:PROCOM.DEF'
	INCLUDE 'INCLIB:SIMCOM.DEF'
C
	INTEGER*4 OUTPUT_BUF,XREF_BUF
	INTEGER*4 DELAY_OFFSET			!OFFSET IN STATS TAB
	INTEGER*4 LOOPBACK_TYPE /Z0000C000/	!LOOPBACK TYPE/SUBTYPE
	INTEGER*4 INPUT_LEN,OUTPUT_LEN          !MESSAGE LENGTH
	INTEGER*4 TRANSACTION_TYPE
	INTEGER*4 TYPE_MASK /Z0000FF00/		!TYPE/SUBTYPE MASK
	INTEGER*4 ST
C
	INTEGER*4 LOOP_INPLEN_OFF,LOOP_OUTLEN_OFF,LOOP_DELAY_OFF !OFFSETS
C							    IN LOOBACK MESSAGE
	INTEGER*4 LOOP_RESPONSE_OFF		!RESPONSE OFFSET
	PARAMETER (LOOP_RESPONSE_OFF=4)
	PARAMETER (LOOP_INPLEN_OFF=9)		!LENGTH TO RETURN
	PARAMETER (LOOP_OUTLEN_OFF=10)		!LENGTH OF THIS MESSAGE
	PARAMETER (LOOP_DELAY_OFF=2)		!DELAY TO SEND NEXT MESSAGE
	INTEGER*4 LOOP_MIN_LEN			!MINIMUM LENGTH OF LOOPBACK MSG
	PARAMETER (LOOP_MIN_LEN=10)
C
	INTEGER*4 PRO_SIM_TYPE			!!!!SIMULATION TYPE OFFSET
C					        !IN PROCOM BUF
	PARAMETER (PRO_SIM_TYPE=24)
C
C
C	UPDATE DELAY STATS
C
	IF (XREF_BUF.LT.0) THEN
	    SIM_DELAY(OUTPUT_BUF)=SYSTIM-SIM_DELAY(OUTPUT_BUF)
	    DELAY_OFFSET=SIM_DELAY(OUTPUT_BUF)/SIM_DELAY_RESOLUTION
	    IF (DELAY_OFFSET.GT.SIM_DELAY_STAT_MAX)
     *                  DELAY_OFFSET=SIM_DELAY_STAT_MAX
	    IF (DELAY_OFFSET.LE.0) DELAY_OFFSET=1
	    SIM_DELAY_STATS(DELAY_OFFSET)=SIM_DELAY_STATS(DELAY_OFFSET)+1
	    TRANSACTION_TYPE=SIM_SIMULATED_TYPE(OUTPUT_BUF) !TRANS TYPE
	    SIM_DELAY_TYPE(DELAY_OFFSET,TRANSACTION_TYPE)=
     *		      SIM_DELAY_TYPE(DELAY_OFFSET,TRANSACTION_TYPE)+1
	    CALL ABL(OUTPUT_BUF,SIM_SIMQUE_OUT,ST) !SIMULATION OUTPUT
C
	 ELSEIF (XREF_BUF.GT.0 .AND. XREF_BUF.LE.NUMPRO) THEN
	   IF (IAND(PRO(INPTAB,XREF_BUF),TYPE_MASK).EQ.LOOPBACK_TYPE) THEN
 
C
C	    SHOULD DO SOME FURTHER CHECKS HERE
C	    IF IT SHOULD PROCESS THE MESSAGE
C	    QUEUE TRANSACTION TO OUTPUT
C
	    OUTPUT_LEN=HPRO(OUTLEN,OUTPUT_BUF)   !LENGTH TO SEND BACK
	    IF (OUTPUT_LEN.LE.LOOP_MIN_LEN) OUTPUT_LEN=LOOP_MIN_LEN
	    INPUT_LEN=SIM_MSG_INPUT_LEN(OUTPUT_BUF) !SIMULATED MSG LEN
	    CALL ABL(OUTPUT_BUF,SIM_SIMQUE_OUT,ST) !SIMULATION OUTPUT
C
C	UPDATE LOOPBACK OUTPUT MESSAGE
C
	    OUTPUT_BUF=XREF_BUF
	    HPRO(OUTLEN,OUTPUT_BUF)=OUTPUT_LEN
	    CALL ISBYTE(INPUT_LEN,PRO(INPTAB,OUTPUT_BUF),
     *                                          LOOP_INPLEN_OFF-1)
 	    CALL ISBYTE(OUTPUT_LEN,PRO(INPTAB,OUTPUT_BUF),
     *					        LOOP_OUTLEN_OFF-1)
	    CALL ISBYTE(P(LOOPDLAY),PRO(INPTAB,OUTPUT_BUF),
     *					        LOOP_DELAY_OFF-1)
	   ENDIF
	ENDIF
	RETURN
	END
