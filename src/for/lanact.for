C
C SUBROUTINE LANACT
C
C*************************** START X2X PVCS HEADER ****************************
C
C  $Logfile::   GXAFXT:[GOLS]LANACT.FOV                                   $
C  $Date::   17 Apr 1996 13:46:34                                         $
C  $Revision::   1.0                                                      $
C  $Author::   HXK                                                        $
C
C**************************** END X2X PVCS HEADER *****************************
C
C  Based on Netherlands Bible, 12/92, and Comm 1/93 update
C  DEC Baseline
C
C ** Source - lanact.for;1 **
C
C LANACT.FOR
C
C V03  4-JUN-92 JWE Put some more data checks in...
C V02 29-MAY-92 JWE Dump stack on bad data...
C V01 01-AUG-90 XXX RELEASED FOR VAX
C
C V01 06-JUN-89 MBK ORIGINAL RELEASE
C
C CALL LANACT(EVENT,SSAP,DSAP,BUF)
C
C EVENT - INT*4   EVENT NUMBER
C SSAP  - INT*4   SENDING END OF THE CONNECTION       these are from
C DSAP  - INT*4   RECEIVING END OF THE CONNECTION     the buffer if buf ne 0
C BUF   - INT*4   BUFFER NUMBER (IF BUF=0, NO BUFFER INVOLVED)
C
C EXECUTE ALL CONNECTION RELATED ACTIVITIES WHEN BEING IN OLDSTATE
C AND EVENT HAPPENS. ALSO CHANGE THE STATE OF THE CONNECTION TO NEWSTATE.
C
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C This item is the property of GTECH Corporation, Providence, Rhode
C Island, and contains confidential and trade secret information. It
C may not be transferred from the custody or control of GTECH except
C as authorized in writing by an officer of GTECH. Neither this item
C nor the information it contains may be used, transferred,
C reproduced, published, or disclosed, in whole or in part, and
C directly or indirectly, except as expressly authorized by an
C officer of GTECH, pursuant to written agreement.
C
C Copyright 1994 GTECH Corporation. All rights reserved.
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C=======OPTIONS /CHECK=NOOVERFLOW
	SUBROUTINE LANACT(EVENT,SSAP,DSAP,BUF)
	IMPLICIT NONE
C
	INCLUDE 'INCLIB:SYSPARAM.DEF'
	INCLUDE 'INCLIB:SYSEXTRN.DEF'
C
	INCLUDE 'INCLIB:LANCOM.DEF'
C
	INTEGER*4 DELAY, QUECNT, SSAPSTS, LAN, ST, QUE, SWITCH
	INTEGER*4 OLDSTATE, CONN, BUF, DSAP, SSAP, EVENT
	INTEGER*4 LABEL
C
	LABEL = 0
C
C VERIFY PARAMETERS
C
	IF(BUF.LT.0.OR.BUF.GT.LANBNUM.OR.
     *	   SSAP.LT.0.OR.SSAP.GT.MAXSAP.OR.
     *	   DSAP.LT.0.OR.DSAP.GT.MAXSAP.OR.
     *	   EVENT.LE.0.OR.EVENT.GT.MAXEVENT) THEN
	      CALL OPS('INVALID ACTION', DSAP, EVENT)
D	      TYPE *,IAM(),
D	1	'**** INVALID ACTION ****[',BUF,SSAP,DSAP,EVENT,']'
		 LABEL = 1
	      GOTO 90000                    !RETURN BUFEFR IF GT 0 AND LEAVE
	ENDIF
C
	CONN=CONNECTION(SSAP,DSAP)
	IF(CONN.LE.0.OR.CONN.GT.MAXCON) THEN
	   CALL OPS('**** ILLEGAL CONNECTION ****',CONN, CONN)
	   GOTO 90000
	ENDIF
C
	OLDSTATE=LANCONN(CONN)
C
C NOW SWITCH ON BIG SWITCH TABLE     (TABLE OF LABELS)
C
	SWITCH=(EVENT-1)*MAXSTATE+OLDSTATE
C
C                        TABLE OF STATES
C
C   * ST  CLOSED   FIND_PEND  CON_PENG   OPEN      IDLE     DIS_PENG
C  EV *      1         2         3         4         5         6
C----------!--------------------------------------------------------!
C C_REQ  1 ! 2         2         3         4         5         6    !LOC SAP
C C_IND  2 ! 4         4         4         4         4         1    !REM SAP
C C_CONF 3 ! 1         1         4         4         4         1    !REM SAP
C D_REQ  4 ! 1         1         1         6         6         6    !LOC SAP
C D_IND  5 ! 1         1         1         1         1         1    !REM SAP
C D_CONF 6 ! 1         1         1         1         1         1    !REM SAP
C F_IND  7 ! 1         2         3         4         4         1    !REM DLL
C F_CONF 8 ! 1         3         3         4         4         1    !REM DLL
C TOUT   9 ! 1         1         1         5         1         1    !LOC DLL
C DTA_I 10 ! 1         2         3         4         4         6    !REM SAP
C TICK  11 ! 1         2         3         4         5         6    !LOC DLL
C CLEAR 12 ! 1         1         1         1         1         1    !REM SAP
C P_IND 13 ! 1         2         3         4         4         6    !REM DLL
C P_CONF14 ! 1         2         3         4         4         6    !REM DLL
C DTA_RE15 ! 1         2         3         4         5         6    !LOC SAP
C DTA_OV16 ! 1         2         3         1         1         6    !REM SAP
C----------!--------------------------------------------------------!
C
C THE ABOVE TABLE IS CODED IN LOCTABLES.DEF (MAINTAIN IT!!)
C
C THE SWITCH ACTION TABLE SHOULD BE COMPRESSED LATER ON
C
C                SWITCH ACTION TABLE
C
	IF(EVENT.NE.EVNTICK) THEN
D	   TYPE*,'**** OLD EVN SWT ****[',OLDSTATE,EVENT,SWITCH,']'
	   CALL LANTRACE(DSAP,SSAP,OLDSTATE,EVENT)
	ENDIF
C
	GOTO ( 100, 200, 300, 400, 500, 600,
     *	       700, 800, 900,1000,1100,1200,
     *	      1300,1400,1500,1600,1700,1800,
     *	      1900,2000,2100,2200,2300,2400,
     *	      2500,2600,2700,2800,2900,3000,
     *	      3100,3200,3300,3400,3500,3600,
     *	      3700,3800,3900,4000,4100,4200,
     *	      4300,4400,4500,4600,4700,4800,
     *	      4900,5000,5100,5200,5300,5400,
     *	      5500,5600,5700,5800,5900,6000,
     *	      6100,6200,6300,6400,6500,6600,
     *	      6700,6800,6900,7000,7100,7200,
     *	      7300,7400,7500,7600,7700,7800,
     *	      7900,8000,8100,8200,8300,8400,
     *	      8500,8600,8700,8800,8900,9000,
     *	      9100,9200,9300,9400,9500,9600),   SWITCH
C
C*  GOTO 90000 WILL RELEASE THE BUFEFR AND RETURN
C*
C*  GOTO 95000 WILL ONLY RETURN
C
C ILLEGAL BRANCH
C
	CALL OPS('ILLEGAL BRANCH FROM SWITCH TABLE', SWITCH, SWITCH)
	GOTO 90000
C
100	CONTINUE
C
C SEND FIND IN BROADCAST MODE
C
	LANTOUT(CONN)=LANTIMER+LANDEL2
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMFREQ(SSAP,DSAP,BUF)
	GOTO 95000
C
200	CONTINUE
C
C  NACK REQUEST FROM APPL
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	QUE=QUESAP(SSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCONREQ      !IT IS AN ANSWER TO APPL
	LANBUF(LANDATAF+1,BUF)=CREPLYBAD  !THIS A REPLY TO CONREQ FROM APPL
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)    !
	IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)  !CONTEXT SAYS: REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	GOTO 95000
C
300	CONTINUE
C
C  NACK REQUEST FROM APPL
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	QUE=QUESAP(SSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCONREQ      !IT IS AN ANSWER TO APPL
	LANBUF(LANDATAF+1,BUF)=CREPLYBAD  !THIS A REPLY TO CONREQ FROM APPL
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)    !
	IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)  !CONTEXT SAYS: REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	GOTO 95000
C
400	CONTINUE
C
C  NACK REQUEST FROM APPL
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	QUE=QUESAP(SSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCONREQ      !IT IS AN ANSWER TO APPL
	LANBUF(LANDATAF+1,BUF)=CREPLYBAD  !THIS A REPLY TO CONREQ FROM APPL
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)    !
	IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)  !CONTEXT SAYS: REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	GOTO 95000
C
500	CONTINUE
C
C  NACK REQUEST FROM APPL
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	QUE=QUESAP(SSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCONREQ      !IT IS AN ANSWER TO APPL
	LANBUF(LANDATAF+1,BUF)=CREPLYBAD  !THIS A REPLY TO CONREQ FROM APPL
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)    !
	IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)  !CONTEXT SAYS: REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	GOTO 95000
C
600	CONTINUE
C
C  NACK REQUEST FROM APPL
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	QUE=QUESAP(SSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCONREQ      !IT IS AN ANSWER TO APPL
	LANBUF(LANDATAF+1,BUF)=CREPLYBAD  !THIS A REPLY TO CONREQ FROM APPL
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)    !
	IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)  !CONTEXT SAYS: REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	GOTO 95000
C
700	CONTINUE
C
C CHANGE STATE, INDICATE CONNECTION TO APPL, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 700
		GOTO 90000
	ENDIF
	IF(LANSAPSTS(DSAP).EQ.SAPUP) THEN
	   CURLAN(CONN)=LAN                  !I WAS ASKED WITH FIND ABOUT LAN
	   CALL FRMCCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
C
	   QUE=QUESAP(DSAP)
	   CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	   IF(ST.NE.2) THEN
	      LANBUF(LANBTYP,BUF)=LTYPCMD
	      LANBUF(LANDATAF,BUF)=CCONNIND       !IT'S NOT AN ANSWER TO APPL
	      LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	      LANBUF(LANDATAF+2,BUF)=SSAP
	      LANBUF(LANDATAF+3,BUF)=DSAP
	      LANBUF(LANOWN,BUF)=OWNAPPL
	      CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	      IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	      CALL QUEUE(LANTASKS(QUE),BUF,ST)    !FROM CONTEXT IF THERE IS REPL
	      IF(ST.NE.0) THEN
	         CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	      ENDIF
	      ENDIF
	   ENDIF
	ELSE
	   CALL FRMCLEAR(DSAP,SSAP,BUF)
	ENDIF
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
800	CONTINUE
C
C CHANGE STATE, INDICATE CONNECTION TO APPL, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 800
		GOTO 90000
	ENDIF
	IF(LANSAPSTS(DSAP).EQ.SAPUP) THEN
	   CURLAN(CONN)=LAN                  !I WAS ASKED WITH FIND ABOUT LAN
	   CALL FRMCCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
C
	   QUE=QUESAP(DSAP)
	   CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	   IF(ST.NE.2) THEN
	      LANBUF(LANBTYP,BUF)=LTYPCMD
	      LANBUF(LANDATAF,BUF)=CCONNIND       !IT'S NOT AN ANSWER TO APPL
	      LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	      LANBUF(LANDATAF+2,BUF)=SSAP
	      LANBUF(LANDATAF+3,BUF)=DSAP
	      LANBUF(LANOWN,BUF)=OWNAPPL
	      CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	      IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	      CALL QUEUE(LANTASKS(QUE),BUF,ST)    !FROM CONTEXT IF THERE IS REPL
	      IF(ST.NE.0) THEN
	         CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	      ENDIF
	      ENDIF
	   ENDIF
	ELSE
	   CALL FRMCLEAR(DSAP,SSAP,BUF)
	ENDIF
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
900	CONTINUE
C
C CHANGE STATE, INDICATE CONNECTION TO APPL, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 900
		GOTO 90000
	ENDIF
	IF(LANSAPSTS(DSAP).EQ.SAPUP) THEN
	   CURLAN(CONN)=LAN                  !I WAS ASKED WITH FIND ABOUT LAN
	   CALL FRMCCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
C
	   QUE=QUESAP(DSAP)
	   CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	   IF(ST.NE.2) THEN
	      LANBUF(LANBTYP,BUF)=LTYPCMD
	      LANBUF(LANDATAF,BUF)=CCONNIND       !IT'S NOT AN ANSWER TO APPL
	      LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	      LANBUF(LANDATAF+2,BUF)=SSAP
	      LANBUF(LANDATAF+3,BUF)=DSAP
	      LANBUF(LANOWN,BUF)=OWNAPPL
	      CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	      IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	      CALL QUEUE(LANTASKS(QUE),BUF,ST)    !FROM CONTEXT IF THERE IS REPL
	      IF(ST.NE.0) THEN
	         CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	      ENDIF
	      ENDIF
	   ENDIF
	ELSE
	   CALL FRMCLEAR(DSAP,SSAP,BUF)
	ENDIF
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
1000	CONTINUE
C
C CHANGE STATE, INDICATE CONNECTION TO APPL, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 1000
		GOTO 90000
	ENDIF
	CURLAN(CONN)=LAN
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMCCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CCONNIND       !IT'S NOT AN ANSWER TO APPL
	   LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	   LANBUF(LANDATAF+2,BUF)=SSAP
	   LANBUF(LANDATAF+3,BUF)=DSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	   IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPL
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	GOTO 95000
C
1100	CONTINUE
C
C CHANGE STATE, INDICATE CONNECTION TO APPL, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 1100
		GOTO 90000
	ENDIF
	CURLAN(CONN)=LAN
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMCCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CCONNIND       !IT'S NOT AN ANSWER TO APPL
	   LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	   LANBUF(LANDATAF+2,BUF)=SSAP
	   LANBUF(LANDATAF+3,BUF)=DSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	   IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPL
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	GOTO 95000
C
1200	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT INDICATE
C
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISIND        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000           !DONT RETURN BUF AND LEAVE
C
1300	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT INDICATE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISIND        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
1400	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT INDICATE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTARR(CONN)=0
	CURLAN(CONN)=0
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISIND        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
1500	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, CONNECT INDICATE
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 1500
		GOTO 90000
	ENDIF
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
C
	QUE=QUESAP(DSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCONREQ       !IT AN ANSWER TO APPL COMMAND
	LANBUF(LANDATAF+1,BUF)=CREPLYOK     !ANSWER MODE
	LANBUF(LANDATAF+2,BUF)=DSAP
	LANBUF(LANDATAF+3,BUF)=SSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMNAD MODE
	IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
1600	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DUMP BUFFER
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
C
	GOTO 90000                              !RETURN BUF AND LEAVE
C
1700	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DUMP BUFFER
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
C
	GOTO 90000                              !RETURN BUF AND LEAVE
C
1800	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT INDICATE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISIND        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
1900	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT REPLY OK
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(SSAP)                    !BUF CAME FROM APPL IN THIS STATION
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CDISREQ        !IT AN ANSWER TO APPL COMMAND
	LANBUF(LANDATAF+1,BUF)=CREPLYOK     !ANSWER MODE
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMNAD MODE
	IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2000	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT REPLY BAD
C
	CALL FRMCLEAR(SSAP,DSAP,BUF)      !BUF CAME FROM HERE
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(SSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISREQ        !IT IS AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CREPLYOK     !REQUEST
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(SSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2100	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT REPLY BAD
C
	CALL FRMCLEAR(SSAP,DSAP,BUF)      !BUF CAME FROM HERE
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(SSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISREQ        !IT IS AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CREPLYOK     !REQUEST
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.TRAPYES) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(SSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2200	CONTINUE
C
C SEND DISC REQ
C
	LANTOUT(CONN)=LANTIMER+LANDEL2
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMDREQ(SSAP,DSAP,BUF)              !CAME FROM HERE
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2300	CONTINUE
C
C SEND DISC REQ
C
	LANTOUT(CONN)=LANTIMER+LANDEL2
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMDREQ(SSAP,DSAP,BUF)              !CAME FROM HERE
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2400	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT REPLY BAD
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
C
	QUE=QUESAP(SSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CDISREQ        !IT IS AN ANSWER TO APPL
	LANBUF(LANDATAF+1,BUF)=CREPLYOK     !REQUEST
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)      !REPLY MODE
	IF(LANTRPTSK(QUE).EQ.1) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2500	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT IND TO APPL, RESPOND
C
	CALL FRMDCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	CURLAN(CONN)=0
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CDISIND        !IT AN IND COMMAND
	   LANBUF(LANDATAF+1,BUF)=CCOMMAND     !COMMAND MODE
	   LANBUF(LANDATAF+2,BUF)=SSAP
	   LANBUF(LANDATAF+3,BUF)=DSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO ANSWER MODE
	   IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPL
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2600	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT IND TO APPL, RESPOND
C
	CALL FRMDCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	CURLAN(CONN)=0
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTARR(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CDISIND        !IT AN IND COMMAND
	   LANBUF(LANDATAF+1,BUF)=CCOMMAND     !COMMAND MODE
	   LANBUF(LANDATAF+2,BUF)=SSAP
	   LANBUF(LANDATAF+3,BUF)=DSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO ANSWER MODE
	   IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPL
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2700	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT IND TO APPL, RESPOND
C
	CALL FRMDCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	CURLAN(CONN)=0
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CDISIND        !IT AN IND COMMAND
	   LANBUF(LANDATAF+1,BUF)=CCOMMAND     !COMMAND MODE
	   LANBUF(LANDATAF+2,BUF)=SSAP
	   LANBUF(LANDATAF+3,BUF)=DSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO ANSWER MODE
	   IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPL
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2800	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT IND TO APPL, RESPOND
C
	CALL FRMDCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	CURLAN(CONN)=0
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CDISIND        !IT AN IND COMMAND
	   LANBUF(LANDATAF+1,BUF)=CCOMMAND     !COMMAND MODE
	   LANBUF(LANDATAF+2,BUF)=SSAP
	   LANBUF(LANDATAF+3,BUF)=DSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO ANSWER MODE
	   IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPL
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
2900	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT IND TO APPL, RESPOND
C
	CALL FRMDCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	CURLAN(CONN)=0
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CDISIND        !IT AN IND COMMAND
	   LANBUF(LANDATAF+1,BUF)=CCOMMAND     !COMMAND MODE
	   LANBUF(LANDATAF+2,BUF)=SSAP
	   LANBUF(LANDATAF+3,BUF)=DSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO ANSWER MODE
	   IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPL
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
3000	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT IND TO APPL, RESPOND
C
	CALL FRMDCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	CURLAN(CONN)=0
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CDISIND        !IT AN IND COMMAND
	   LANBUF(LANDATAF+1,BUF)=CCOMMAND     !COMMAND MODE
	   LANBUF(LANDATAF+2,BUF)=SSAP
	   LANBUF(LANDATAF+3,BUF)=DSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO ANSWER MODE
	   IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPL
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
3100	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT REPLY OK
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)                    !BUF CAME FROM DLL
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CDISREQ        !IT AN ANSWER TO APPL COMMAND
	LANBUF(LANDATAF+1,BUF)=CREPLYOK     !ANSWER MODE
	LANBUF(LANDATAF+2,BUF)=DSAP
	LANBUF(LANDATAF+3,BUF)=SSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMNAD MODE
	IF(LANTRPTSK(QUE).EQ.1) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
3200	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, CON REQ REPLY BAD
C
	CALL FRMCLEAR(DSAP,SSAP,BUF)            !CAME FROM REMOTE
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CCONREQ        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CREPLYOK     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=DSAP
	  LANBUF(LANDATAF+3,BUF)=SSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.1) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
3300	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, CON REQ REPLY BAD
C
	CALL FRMCLEAR(DSAP,SSAP,BUF)            !CAME FROM REMOTE
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CCONREQ        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CREPLYOK     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=DSAP
	  LANBUF(LANDATAF+3,BUF)=SSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.1) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
3400	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT INDICATE
C
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISIND        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.1) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
3500	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT INDICATE
C
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISIND        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.1) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
3600	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DISCONNECT REPLY OK
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)                    !BUF CAME FROM DLL
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CDISREQ        !IT AN ANSWER TO APPL COMMAND
	LANBUF(LANDATAF+1,BUF)=CREPLYOK     !ANSWER MODE
	LANBUF(LANDATAF+2,BUF)=DSAP
	LANBUF(LANDATAF+3,BUF)=SSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMNAD MODE
	IF(LANTRPTSK(QUE).EQ.1) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
3700	CONTINUE
C
C CHANGE STATE, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 3700
		GOTO 90000
	ENDIF
	LANLAN(SSAP,LAN)=LANUP
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMFCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
3800	CONTINUE
C
C CHANGE STATE, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 3800
		GOTO 90000
	ENDIF
	LANLAN(SSAP,LAN)=LANUP
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMFCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
3900	CONTINUE
C
C CHANGE STATE, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 3900
		GOTO 90000
	ENDIF
	LANLAN(SSAP,LAN)=LANUP
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMFCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
4000	CONTINUE
C
C CHANGE STATE, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 4000
		GOTO 90000
	ENDIF
	LANLAN(SSAP,LAN)=LANUP
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMFCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
4100	CONTINUE
C
C CHANGE STATE, ACT ON FRAME, RESPOND
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 4100
		GOTO 90000
	ENDIF
	LANLAN(SSAP,LAN)=LANUP
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMFCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
4200	CONTINUE
C
C CHANGE STATE, ACT ON FRAME, RESPOND WITH CLEAR
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 4200
		GOTO 90000
	ENDIF
	LANLAN(SSAP,LAN)=LANUP
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000
C
4300	CONTINUE
C
C CHANGE STATE, ACT ON FRAME, RESPOND WITH CLEAR
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 4300
		GOTO 90000
	ENDIF
	LANLAN(SSAP,LAN)=LANUP
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
4400	CONTINUE
C
C SEND CREQ  IF SAP OPEN
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 4400
		GOTO 90000
	ENDIF
	LANLAN(SSAP,LAN)=LANUP
	CURLAN(CONN)=LAN
	IF(SSAPSTS.EQ.SAPUP) THEN
	   CURLAN(CONN)=LAN               !FIRST RESPONSE BEST RESPONSE
	   LANTARR(CONN)=LANTIMER
	   LANTOUT(CONN)=LANTIMER+LANDEL2
	   CALL FRMCREQ(DSAP,SSAP,BUF)
	ELSE
	   LANTOUT(CONN)=0
	   QUE=QUESAP(DSAP)                  !HERE
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CCONREQ      !IT IS AN ANSWER TO APPL
	   LANBUF(LANDATAF+1,BUF)=CREPLYBAD  !THIS A REPLY TO CONREQ FROM APPL
	   LANBUF(LANDATAF+2,BUF)=DSAP
	   LANBUF(LANDATAF+3,BUF)=SSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)    !
	   IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)  !CONTEXT SAYS: REPLY
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
4500	CONTINUE
C
C CHANGE STATE, ACT ON FRAME
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	LANLAN(SSAP,LAN)=LANUP                    !IMPORTANT
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000                                !DUMP BUFFER
C
4600	CONTINUE
C
C CHANGE STATE, ACT ON FRAME
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	LANLAN(SSAP,LAN)=LANUP
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000                                !DUMP BUFFER
C
4700	CONTINUE
C
C CHANGE STATE, ACT ON FRAME
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	LANLAN(SSAP,LAN)=LANUP
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000                                !DUMP BUFFER
C
4800	CONTINUE
C
C SEND CLEARERQ
C
	CALL FRMCLEAR(DSAP,SSAP,BUF)            !CAME FROM REMOTE
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
4900	CONTINUE
C
C RESET TOUT CHANGE STATE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	GOTO 90000   !NO BUFFER
C
5000	CONTINUE
C
C CHANGE STATE, RESET TOUT, CONNECT BAD RESP
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(SSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CCONREQ        !IT IS AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CREPLYBAD    !REPLY MODE
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMAND MODE
	  IF(LANTRPTSK(QUE).EQ.1) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(SSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
5100	CONTINUE
C
C CHANGE STATE, RESET TOUT, REPOND BAD
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	LAN=CURLAN(CONN)
	IF(LAN.GT.0.AND.LAN.LE.MAXLAN)LANLAN(DSAP,LAN)=LANDOWN
	CURLAN(CONN)=0
C
	QUE=QUESAP(SSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CCONREQ        !IT IS AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CREPLYBAD    !REPLY MODE
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMAND MODE
	  IF(LANTRPTSK(QUE).EQ.1) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(SSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
5200	CONTINUE
C
C RESET TOUT CHANGE STATE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	GOTO 95000   !NO BUFFER
C
5300	CONTINUE
C
C CHANGE STATE, RESET TOUT, DISCONNECT INDICATE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	LAN=CURLAN(CONN)
	IF(LAN.GT.0.AND.LAN.LE.MAXLAN)LANLAN(DSAP,LAN)=LANDOWN
	CURLAN(CONN)=0
C
	QUE=QUESAP(SSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	   LANTARR(CONN)=0
	   LANTOUT(CONN)=0
	   LANBUF(LANBTYP,BUF)=LTYPCMD
	   LANBUF(LANDATAF,BUF)=CDISIND
	   LANBUF(LANDATAF+1,BUF)=CCOMMAND
	   LANBUF(LANDATAF+2,BUF)=DSAP
	   LANBUF(LANDATAF+3,BUF)=SSAP
	   LANBUF(LANOWN,BUF)=OWNAPPL
	   CALL ABL(BUF,LANAPP(1,QUE),ST)
	   IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST) !CONTEXT DECIDES IF THERE IS REPLY
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	   ENDIF
	ENDIF
	CALL CHKQSCE(SSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
5400	CONTINUE
C
C CHANGE STATE, RESET TOUT, DISCONNECT INDICATE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(SSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISREQ        !IT IS AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CREPLYOK     !REPLY MODE
	  LANBUF(LANDATAF+2,BUF)=SSAP
	  LANBUF(LANDATAF+3,BUF)=DSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMAND MODE
	  IF(LANTRPTSK(QUE).EQ.1) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	CALL CHKQSCE(SSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
5500	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	CURLAN(CONN)=0
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
5600	CONTINUE
C
C RESET TOUT CHANGE STATE
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000   ! RELEASE BUFFER
C
5700	CONTINUE
C
C RESET TOUT CHANGE STATE
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000   !RELEASE BUFFER
C
5800	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DATA INDICATE
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 5800
		GOTO 90000
	ENDIF
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
C
	QUE=QUESAP(DSAP)
C
	LANBUF(LANBTYP,BUF)=LTYPDATA
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)     !AS OPPOSED TO COMMNAD MODE
	IF(QUECNT(LANAPP(1,QUE)).LE.1) THEN!KICK ONLY IF EMPTY QUEUE
	IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)!CONTEXT DECIDES IF THERE IS REPLY
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	ENDIF
	ENDIF
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
5900	CONTINUE
C
C CHANGE STATE, RESET TOUT AND TARR, DATA INDICATE
C
	CALL ACTON(LAN,SSAP,DSAP,SSAPSTS,BUF)
	IF(LANBUF(LANBTYP,BUF) .NE. LTYPDATA .AND.
	1   LANBUF(LANBTYP,BUF) .NE. LTYPCMD)THEN
		LABEL = 5900
		GOTO 90000
	ENDIF
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
C
	QUE=QUESAP(DSAP)
	LANBUF(LANBTYP,BUF)=LTYPDATA
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMNAD MODE
	IF(QUECNT(LANAPP(1,QUE)).LE.1) THEN!KICK ONLY IF EMPTY QUEUE
	IF(LANTRPTSK(QUE).EQ.1) THEN
	   CALL QUEUE(LANTASKS(QUE),BUF,ST)!CONTEXT DECIDES IF THERE IS REPLY
	   IF(ST.NE.0) THEN
	      CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	   ENDIF
	ENDIF
	ENDIF
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
6000	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR
C
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	CURLAN(CONN)=0
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
6100	CONTINUE
C
C DO NOTHING
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
6200	CONTINUE
C
C DO NOTHING
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
6300	CONTINUE
C
C DO NOTHING
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
6400	CONTINUE
C
C CHECK TOUT
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	IF(LANTARR(CONN).GT.0) THEN
	   DELAY=MAX0(0,LANTIMER-LANTARR(CONN))
	   IF(DELAY.GT.LANDEL1) THEN
	      LANTOUT(CONN)=LANTIMER  !SCHED TIMEOUT NOW!!!!
	   ENDIF
	ENDIF
	GOTO 95000
C
6500	CONTINUE
C
C POLL, CHECK TOUT
C
	BUF=0
	CALL FRMPREQ(SSAP,DSAP,BUF)
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	IF(LANTARR(CONN).GT.0) THEN
	   DELAY=MAX0(0,LANTIMER-LANTARR(CONN))
	   IF(DELAY.GT.LANDEL2) THEN
	      LANTOUT(CONN)=LANTIMER  !SCHED TIMEOUT NOW!!!!
	   ENDIF
	ENDIF
	GOTO 95000
C
6600	CONTINUE
C
C DO NOTHING
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
6700	CONTINUE
C
C RESET TOUT CHANGE STATE
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000   ! RELEASE BUFFER
C
6800	CONTINUE
C
C CHANGE STATE, RESET TOUT, CONNECT BAD RESP
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCONREQ        !IT IS AN ANSWER TO APPL
	LANBUF(LANDATAF+1,BUF)=CREPLYBAD    !REPLY MODE
	LANBUF(LANDATAF+2,BUF)=DSAP
	LANBUF(LANDATAF+3,BUF)=SSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMAND MODE
	IF(LANTRPTSK(QUE).EQ.1) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
6900	CONTINUE
C
C CHANGE STATE, RESET TOUT, CONNEDT KNOCKED DOWN
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CCONREQ        !IT IS AN ANSWER TO APPL
	LANBUF(LANDATAF+1,BUF)=CREPLYBAD    !REPLY MODE
	LANBUF(LANDATAF+2,BUF)=DSAP
	LANBUF(LANDATAF+3,BUF)=SSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO COMMAND MODE
	IF(LANTRPTSK(QUE).EQ.1) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
7000	CONTINUE
C
C CHANGE STATE, RESET TOUT, DISC IND
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CDISIND
	LANBUF(LANDATAF+1,BUF)=CCOMMAND
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)
	IF(LANTRPTSK(QUE).EQ.1) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
7100	CONTINUE
C
C CHANGE STATE, RESET TOUT, DISC IND
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CDISIND
	LANBUF(LANDATAF+1,BUF)=CCOMMAND
	LANBUF(LANDATAF+2,BUF)=SSAP
	LANBUF(LANDATAF+3,BUF)=DSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)
	IF(LANTRPTSK(QUE).EQ.1) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
7200	CONTINUE
C
C CHANGE STATE, RESET TOUT, DISC IND
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(DSAP)
	LANBUF(LANBTYP,BUF)=LTYPCMD
	LANBUF(LANDATAF,BUF)=CDISIND
	LANBUF(LANDATAF+1,BUF)=CCOMMAND
	LANBUF(LANDATAF+2,BUF)=DSAP
	LANBUF(LANDATAF+3,BUF)=SSAP
	LANBUF(LANOWN,BUF)=OWNAPPL
	CALL ABL(BUF,LANAPP(1,QUE),ST)
	IF(LANTRPTSK(QUE).EQ.1) THEN
	CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	IF(ST.NE.0) THEN
	   CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	ENDIF
	ENDIF
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
7300	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	CURLAN(CONN)=0
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
7400	CONTINUE
C
C CHANGE STATE, RESPOND ON POLL
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMPCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
7500	CONTINUE
C
C CHANGE STATE, RESPOND ON POLL
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMPCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
7600	CONTINUE
C
C CHANGE STATE, RESPOND ON POLL
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMPCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
7700	CONTINUE
C
C CHANGE STATE, RESPOND ON POLL
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMPCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
7800	CONTINUE
C
C CHANGE STATE, RESPOND ON POLL
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	CALL FRMPCONF(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
7900	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	CURLAN(CONN)=0
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
8000	CONTINUE
C
C CHANGE STATE
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000
C
8100	CONTINUE
C
C CHANGE STATE
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000
C
8200	CONTINUE
C
C CHANGE STATE
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000
C
8300	CONTINUE
C
C CHANGE STATE
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000
C
8400	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR
C
	LANTARR(CONN)=LANTIMER
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	CURLAN(CONN)=0
	CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	GOTO 95000
C
8500	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT INDICATE
C
	CALL FRMCLEAR(SSAP,DSAP,BUF)      !CAME FROM LOCAL
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(SSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISIND        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=DSAP
	  LANBUF(LANDATAF+3,BUF)=SSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.1) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
8600	CONTINUE
C
C CHANGE STATE , DROP THE BUFEFR
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000
C
8700	CONTINUE
C
C CHANGE STATE , DROP THE BUFFER
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 90000
C
8800	CONTINUE
C
C CHANGE STATE  SEND DATA
C
	CALL FRMDATA(SSAP,DSAP,BUF)      !CAME FROM LOCAL
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
8900	CONTINUE
C
C CHANGE STATE SEND DATA
C
	CALL FRMDATA(SSAP,DSAP,BUF)      !CAME FROM LOCAL
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	GOTO 95000
C
9000	CONTINUE
C
C SEND CLEAR, CHANGE STATE, RESET TOUT AND TARR, DISCONNECT INDICATE
C
	CALL FRMCLEAR(SSAP,DSAP,BUF)      !CAME FROM REMOTE
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=0
	CURLAN(CONN)=0
C
	QUE=QUESAP(SSAP)
	CALL LANGETX(BUF,ST) !FORGET IT IF NO BUFFERS
	IF(ST.NE.2) THEN
	  LANBUF(LANBTYP,BUF)=LTYPCMD
	  LANBUF(LANDATAF,BUF)=CDISIND        !IT'S NOT AN ANSWER TO APPL
	  LANBUF(LANDATAF+1,BUF)=CCOMMAND     !INDICATION (COMMAND) MODE
	  LANBUF(LANDATAF+2,BUF)=DSAP
	  LANBUF(LANDATAF+3,BUF)=SSAP
	  LANBUF(LANOWN,BUF)=OWNAPPL
	  CALL ABL(BUF,LANAPP(1,QUE),ST)      !AS OPPOSED TO REPLY MODE
	  IF(LANTRPTSK(QUE).EQ.1) THEN
	  CALL QUEUE(LANTASKS(QUE),BUF,ST)    !CONTEXT DECIDES IF THERE IS REPLY
	  IF(ST.NE.0) THEN
	     CALL OPS('**** TASK TRAP FAILURE ****',QUE,ST)
	  ENDIF
	  ENDIF
	ENDIF
	GOTO 95000                              !DONT RETURN BUF AND LEAVE
C
9100	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR TO ALL SSAPS CONNECTED TO THIS DSAP
C
	DO 9110 SSAP=1,MAXSAP
C
C IF NOT CLOSED, CLEAR
C
	CONN=CONNECTION(SSAP,DSAP)
	IF(LANCONN(CONN).NE.CSAPCLO) THEN
	   CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	   LANCONN(CONN)=CSAPCLO
	ENDIF
9110	CONTINUE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
C....	GOTO 95000                              !DONT RETURN BUF AND LEAVE
        GOTO 90000
C
9200	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR TO ALL SSAPS CONNECTED TO THIS DSAP
C
	DO 9210 SSAP=1,MAXSAP
C
C IF NOT CLOSED CLEAR
C
	CONN=CONNECTION(SSAP,DSAP)
	IF(LANCONN(CONN).NE.CSAPCLO) THEN
	   CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	   LANCONN(CONN)=CSAPCLO
	ENDIF
9210	CONTINUE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
C....	GOTO 95000                              !DONT RETURN BUF AND LEAVE
        GOTO 90000 
C
9300	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR TO ALL SSAPS CONNECTED TO THIS DSAP
C
	DO 9310 SSAP=1,MAXSAP
C
C IF NOT CLOSED CLEAR
C
	CONN=CONNECTION(SSAP,DSAP)
	IF(LANCONN(CONN).NE.CSAPCLO) THEN
	   CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	   LANCONN(CONN)=CSAPCLO
	ENDIF
9310	CONTINUE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
C...	GOTO 95000                              !DONT RETURN BUF AND LEAVE
        GOTO 90000
C
9400	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR TO ALL SSAPS CONNECTED TO THIS DSAP
C
	DO 9410 SSAP=1,MAXSAP
C
C IF NOT CLOSED CLEAR
C
	CONN=CONNECTION(SSAP,DSAP)
	IF(LANCONN(CONN).NE.CSAPCLO) THEN
	   CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	   LANCONN(CONN)=CSAPCLO
	ENDIF
9410	CONTINUE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
C...	GOTO 95000                              !DONT RETURN BUF AND LEAVE
        GOTO 90000
C
9500	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR TO ALL SSAPS CONNECTED TO THIS DSAP
C
	DO 9510 SSAP=1,MAXSAP
C
C IF NOT CLOSED CLEAR
C
	CONN=CONNECTION(SSAP,DSAP)
	IF(LANCONN(CONN).NE.CSAPCLO) THEN
	   CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	   LANCONN(CONN)=CSAPCLO
	ENDIF
9510	CONTINUE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
C...	GOTO 95000                              !DONT RETURN BUF AND LEAVE
        GOTO 90000
C
9600	CONTINUE
C
C CHANGE STATE, RESPOND WITH CLEAR TO ALL SSAPS CONNECTED TO THIS DSAP
C
	DO 9610 SSAP=1,MAXSAP
C
C IF NOT CLOSED CLEAR
C
	CONN=CONNECTION(SSAP,DSAP)
	IF(LANCONN(CONN).NE.CSAPCLO) THEN
	   CALL FRMCLEAR(DSAP,SSAP,BUF)      !CAME FROM REMOTE
	   LANCONN(CONN)=CSAPCLO
	ENDIF
9610	CONTINUE
C
	LANCONN(CONN)=LANSTATES(EVENT,OLDSTATE)
	LANTOUT(CONN)=0
	LANTARR(CONN)=LANTIMER
	CALL CHKQSCE(DSAP)   !IF QSCED AND LAST CONN DROPPED - CLOSE SAP
C....	GOTO 95000                              !DONT RETURN BUF AND LEAVE
        GOTO 90000
C
C END SEQUENCE
C
90000	CONTINUE
	IF(LABEL .NE. 0)THEN
	    CALL OPS('LANACT ILLEGAL ACTION',LABEL,LABEL)
	    CALL LAN_BUFFER_DUMP(BUF)
	ENDIF
	IF(BUF.GT.0) CALL LANRELB(BUF)
C
95000	RETURN
C
	END
