C
C SUBROUTINE ADDBIN
C $Log:   GXAFXT:[GOLS]ADDBIN.FOV  $
C  
C     Rev 1.0   17 Apr 1996 12:08:08   HXK
C  Release of Finland for X.25, Telephone Betting, Instant Pass Thru Phase 1
C  
C     Rev 1.0   21 Jan 1993 15:35:04   DAB
C  Initial Release
C  Based on Netherlands Bible, 12/92, and Comm 1/93 update
C  DEC Baseline
C
C ** Source - msgsub.for **
C
C
C *** ADDBIN: ADD MESSAGE TO LIST, CHECK FOR '@' AND
C             INSERT ANOTHER @ IF FOUND
C
C IF MESSAGE ALREADY EXISTS, DELETE OLD ONE FIRST
C
C START LOOKING FOR '@' AT OFFSET SPECIFIED AS 'BEGAT'
C
C
C=======OPTIONS /CHECK=NOOVERFLOW
	SUBROUTINE ADDBIN(MSGNUM,MSGBUF,LEN,ERR,BEGAT)
	IMPLICIT NONE
C
	INCLUDE 'INCLIB:SYSPARAM.DEF'
	INCLUDE 'INCLIB:SYSEXTRN.DEF'
C
	INCLUDE 'INCLIB:MSGCOM.DEF'
C
	INTEGER*4   NXTLNK, FSTLEN, ZLEN, MOFF, LINK, K, ATBEG
	INTEGER*4   XLEN, TOTLNK, BEGAT, ERR , LEN, MSGNUM
C
	CHARACTER*1 MSGBUF(LEN)
C
C
	CHARACTER*1 C1MSG(MSGSZH*2,MSGSIZ)
	EQUIVALENCE (C1MSG,MSGTAB)
C
	LOGICAL ATFLAG
C
C
	ERR=-1
	TOTLNK=(LEN-1)/MSGLST + 1
	IF(TOTLNK.GT.MSGTAB(MFRCNT,MSGCTL))GO TO 700
C
	CALL DELMSG(MSGNUM)
C
C
	XLEN=LEN
C
C FIND # OF @ CHARACTERS
C
	ATBEG=BEGAT
	IF(ATBEG.LT.1)ATBEG=1
	DO 50 K=ATBEG,LEN
	  IF(MSGBUF(K).EQ.'@')XLEN=XLEN+1
50	CONTINUE
C
	LINK=MSGNUM
	MOFF=1
C
	ATFLAG=.FALSE.
C
100	CONTINUE
	ZLEN=MIN(XLEN,MSGLST)
	DO 200 K=1,ZLEN
	  IF(ATFLAG)THEN
	    C1MSG(K,LINK)='@'
	    ATFLAG=.FALSE.
	  ELSE
	    C1MSG(K,LINK)=MSGBUF(MOFF)
	    IF(MOFF.GE.ATBEG.AND.MSGBUF(MOFF).EQ.'@')ATFLAG=.TRUE.
	    MOFF=MOFF+1
	  ENDIF
200	CONTINUE
	IF(LINK.EQ.MSGNUM)THEN
	  FSTLEN=ZLEN                 !FOR 1ST BUFFER, SAVE LENGTH
	ELSE
	  MSGTAB(SEGLEN,LINK)=ZLEN
	ENDIF
C
	XLEN=XLEN-ZLEN
	IF(XLEN.LE.0)GO TO 500
	CALL GETFRE(NXTLNK)
	IF(NXTLNK.LE.0)THEN
	  CALL DELMSG(MSGNUM)
	  GO TO 700
	ENDIF
	MSGTAB(MSGLNK,LINK)=NXTLNK
	LINK=NXTLNK
	GO TO 100
C
C
C
C WAIT UNTIL NOW TO SET LENGTH OF FIRST SEGMENT IN ORDER TO LOCK ***
C MESSAGE UNTIL IT IS COMPLETELY WRITTEN, TO MAINTAIN INTEGRITY: ***
C
500	CONTINUE
	MSGTAB(SEGLEN,MSGNUM)=FSTLEN
	ERR=0
C
C
700	CONTINUE
	RETURN
	END
