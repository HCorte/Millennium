C
C SUBROUTINE LWINLOS
C $Log:   GXAFXT:[GOLS]LWINLOS.FOV  $
C  
C     Rev 1.0   17 Apr 1996 13:59:52   HXK
C  Release of Finland for X.25, Telephone Betting, Instant Pass Thru Phase 1
C  
C     Rev 1.1   13 Jul 1995 15:18:38   HXK
C  Changes for Viking Bonus
C  
C     Rev 1.0   21 Jan 1993 16:57:58   DAB
C  Initial Release
C  Based on Netherlands Bible, 12/92, and Comm 1/93 update
C  DEC Baseline
C
C ** Source - winsub.for **
C
C
C
C
C=======OPTIONS /CHECK=NOOVERFLOW
	SUBROUTINE LWINLOS(TRABUF,SHARES,WIN)
	IMPLICIT NONE
C
	INCLUDE 'INCLIB:SYSPARAM.DEF'
	INCLUDE 'INCLIB:SYSEXTRN.DEF'
	INCLUDE 'INCLIB:GLOBAL.DEF'
	INCLUDE 'INCLIB:WINCOM.DEF'
	INCLUDE 'INCLIB:CONCOM.DEF'
	INCLUDE 'INCLIB:DESTRA.DEF'
	INTEGER*4 M, DIV, BONUS, B, MAT, I, ST, GIND, WIN, J, BIND
	INTEGER*4 BT, K, MULT
	INTEGER*4 SHARES(LTGDIV,2),BOARDS(2,12),TSTMAP(2)
	INTEGER*4 MATCH(0:LTGNBR),BMATCH(0:LTGNBR)
C
C
	GIND=TRABUF(TGAMIND)
	CALL FASTSET(0,SHARES,LTGDIV*2)
	IF(TRABUF(TWSYST).EQ.NOSYS) THEN
	  CALL SINTMAP(TRABUF(TWBORD),1,TRABUF(TWNBET),TRABUF(TWNMRK),
     *                LLTMAX(GIND),BOARDS,ST)
	  IF(ST.NE.0) THEN
	    TYPE *,IAM(),' Error status = ',ST
	    TYPE *,IAM(),' Bitmap conversion error ',
     *                   TRABUF(TCDC),TRABUF(TSER)
	    TYPE *,IAM(),' Transaction not processed'
	    RETURN
	  ENDIF
C
	  DO 30 J=0,LLTBDR(GIND)
	  DO 30 I=1,TRABUF(TWNBET)
	  MULT=1
	  IF(TRABUF(TWMFLG).NE.0) MULT=TRABUF(TWMULT+I-1)
C	  CALL BITAND(BOARDS(1,I),LWINMAP(1,J+1,GIND),8,TSTMAP)
	  TSTMAP(1) = IAND(BOARDS(1,I),LWINMAP(1,J+1,GIND))
	  TSTMAP(2) = IAND(BOARDS(2,I),LWINMAP(2,J+1,GIND))
	  CALL BITCNT(TSTMAP,8,MAT)
	  IF(MAT.EQ.0) GOTO 30
	  B=1
	  IF(LLTBFL(GIND).NE.0) THEN
C	    CALL BITAND(BOARDS(1,I),LBONMAP(1,J+1,GIND),8,TSTMAP)
	    TSTMAP(1) = IAND(BOARDS(1,I),LBONMAP(1,J+1,GIND))
	    TSTMAP(2) = IAND(BOARDS(2,I),LBONMAP(2,J+1,GIND))
	    CALL BITCNT(TSTMAP,8,BONUS)
	    IF(BONUS.NE.0) B=2
	  ENDIF
	  DO 10 K=1,LTGBET
	  IF(TRABUF(TWNMRK+I-1).EQ.LLTBET(K,GIND)) THEN
	    BT=K
	    GOTO 20
	  ENDIF
10        CONTINUE
	  GOTO 30
C
20        CONTINUE
	  DIV=LLTWTB(MAT,B,BT,GIND)
	  IF(B.GT.1.AND.DIV.EQ.0) DIV=LLTWTB(MAT,B-1,BT,GIND)
	  IF(J.GT.0.AND.DIV.NE.1) GOTO 30
	  IF(DIV.NE.0) THEN
	    WIN=1
	    BIND=1
	    IF(J.NE.0) BIND=2
	    IF(BIND.EQ.2) THEN
	       IF(DIV.EQ.1) SHARES(DIV,BIND) = SHARES(DIV,BIND) + MULT
	    ELSE
	       SHARES(DIV,BIND) = SHARES(DIV,BIND) + MULT
	    ENDIF
	  ENDIF
30        CONTINUE
	ELSE
	  BT=1
	  MULT=1
	  IF(TRABUF(TWMFLG).NE.0) MULT=TRABUF(TWMULT)
	  DO 50 J=0,LLTBDR(GIND)
	  CALL LSYSCHK(TRABUF(TWBORD),TRABUF(TWSYSN),LWINMAP(1,J+1,GIND),
     *                 LBONMAP(1,J+1,GIND),MATCH,BMATCH) !TRABUF(TWNBET)
	  DO 40 M=1,LTGNBR
	  DO 40 B=1,2
	  DIV=LLTWTB(M,B,BT,GIND)
	  IF(DIV.EQ.0) GOTO 40
	  IF(J.GT.0.AND.DIV.NE.1) GOTO 40
	  IF(B.EQ.1.AND.MATCH(M).NE.0) THEN
	    WIN=1
	    BIND=1
	    IF(J.NE.0) BIND=2
	    IF(BIND.EQ.2) THEN
	       IF(DIV.EQ.1) SHARES(DIV,BIND)=SHARES(DIV,BIND)+MATCH(M)*MULT
	    ELSE
	       SHARES(DIV,BIND)=SHARES(DIV,BIND)+MATCH(M)*MULT
	    ENDIF
	  ENDIF
	  IF(B.EQ.2.AND.BMATCH(M).NE.0) THEN
	    WIN=1
	    BIND=1
	    IF(J.NE.0) BIND=2
	    IF(BIND.EQ.2) THEN
	       IF(DIV.EQ.1) SHARES(DIV,BIND)=SHARES(DIV,BIND)+BMATCH(M)*MULT
	     ELSE
	       SHARES(DIV,BIND)=SHARES(DIV,BIND)+BMATCH(M)*MULT
	     ENDIF
	  ENDIF
40        CONTINUE
50        CONTINUE
	ENDIF
	RETURN
	END
C
