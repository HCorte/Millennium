C
C SUBROUTINE SWIN_SCHKWIN
C
C V07 03-JUL-2000 UXN Refund too late played tickets.
C V06 08-FEB-2000 UXN TFAMTFLG added.
C V05 14-JAN-1999 UXN GET_TEBEID ADDED.
C V04 18-JAN-1994 HXK ADDED LSCWPO UPDATING.
C V03 11-JAN-1994 HXK INITIALIZE NETAMT, TAXAMT, SET DETAILS, BANK NUMS
C V02 03-JAN-1994 HXK ADDED WINS, REFUNDS COUNTS AND AMOUNTS.
C V01 21-JAN-1993 DAB Initial Release
C                     Based on Netherlands Bible, 12/92, and Comm 1/93 update
C                     DEC Baseline
C
C
C
C SUBROUTINE TO CHECK IF SCORE TICKET IS A WINNER
C AND UPDATE VALIDATION RECORDS
C
C
C
C     CALL SWIN_SCHKWIN(TRABUF,V4BUF,WIN)
C INPUT
C          TRABUF - TRANSACTION BODY
C          V4BUF  - VALIDATION RECORD
C OUTPUT
C          V4BUF  - UPDATED FOR NEW WINNER (IF ANY)
C          WIN    - ZERO -> NOT A WINNER
C
C
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C This item is the property of GTECH Corporation, Providence, Rhode
C Island, and contains confidential and trade secret information. It
C may not be transferred from the custody or control of GTECH except
C as authorized in writing by an officer of GTECH. Neither this item
C nor the information it contains may be used, transferred,
C reproduced, published, or disclosed, in whole or in part, and
C directly or indirectly, except as expressly authorized by an
C officer of GTECH, pursuant to written agreement.
C
C Copyright 2000 GTECH Corporation. All rights reserved.
C+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C
C=======OPTIONS /CHECK=NOOVERFLOW
	SUBROUTINE SWIN_SCHKWIN(TRABUF,V4BUF,WIN)
	IMPLICIT NONE
C
	INCLUDE 'INCLIB:SYSPARAM.DEF'
	INCLUDE 'INCLIB:SYSEXTRN.DEF'
	INCLUDE 'INCLIB:GLOBAL.DEF'
	INCLUDE 'INCLIB:CONCOM.DEF'
	INCLUDE 'INCLIB:DESTRA.DEF'
	INCLUDE 'INCLIB:WINCOM.DEF'
	INCLUDE 'INCLIB:DESVAL.DEF'
        INCLUDE 'INCLIB:VALFIL.DEF'
	INCLUDE 'INCLIB:PRMAGT.DEF'
	INCLUDE 'INCLIB:VDETAIL.DEF'
C
	INTEGER*4 WINTAB(TWSBMAX),DUMBET(2,100)
	INTEGER*4 WIN, I, PRZIND, COUNT, ST, GIND, AMTWON, TOTWON
	INTEGER*4 NETAMT,TAXAMT
        INTEGER*4 NAMT,TAMT
	LOGICAL CXLED,REFUND,PRVFLG,HLDFLG
        INTEGER*4 AWNTAB(2,NUMAGT)
        COMMON/BIGWIN/ AWNTAB
	LOGICAL*4   LATEFLG
C
C
	WIN=0
	COUNT=0
	TOTWON=0
        NETAMT=0
        TAXAMT=0
	CXLED = .FALSE.
	REFUND = .FALSE.
	PRVFLG = .FALSE.
	HLDFLG = .FALSE.
	ST=TRABUF(TSTAT)
	GIND=TRABUF(TGAMIND)
	IF(LSCDRW(GIND).LT.0) RETURN
	IF(ST.NE.GOOD.AND.ST.NE.VOID.AND.
     *	   ST.NE.INCA.AND.ST.NE.EXCH) RETURN
	IF(TRABUF(TWBEG).GT.LSCDRW(GIND)) RETURN
	IF(TRABUF(TWEND).LT.LSCDRW(GIND)) RETURN
	IF(TRABUF(TSTAT).EQ.VOID.OR.TRABUF(TSTAT).EQ.INCA) CXLED=.TRUE.
C
	LATEFLG = LSCLAT(LATCDC,GIND).GT.0 .AND.
     *            (LSCLAT(LATCDC,GIND).LT.TRABUF(TCDC).OR.
     *             (LSCLAT(LATCDC,GIND).EQ.TRABUF(TCDC).AND.
     *              LSCLAT(LATTIM,GIND).LT.TRABUF(TTIM)))
C
C CHECK FOR CANCELLED GAME
C
	IF(LSCSTS(GIND).EQ.GAMCAN .OR. LATEFLG) THEN
	  IF(CXLED) RETURN
	  REFUND=.TRUE.
	  WIN=TRABUF(TWNBET)
	  IF(TRABUF(TWSYST).EQ.NOSYS) THEN
	    DO 10 I=1,WIN
	       WINTAB(I)=TRABUF(TWSAMT+(I-1)*TWSBLEN)
	       IF(TRABUF(TFAMTFLG).EQ.1) WINTAB(I)=WINTAB(I)/TRABUF(TNFRAC)
	       IF(LATEFLG) THEN
	          LSCLAT(LATCNT,GIND) = LSCLAT(LATCNT,GIND) + 1
	          LSCLAT(LATAMT,GIND) = LSCLAT(LATAMT,GIND) + WINTAB(I)
	       ENDIF
10	    CONTINUE
	  ELSE
	    WIN=1
	    CALL SSEXP(TRABUF,DUMBET,COUNT)
	    WINTAB(1)=TRABUF(TWSAMT)*COUNT
	    IF(TRABUF(TFAMTFLG).EQ.1) WINTAB(1)=WINTAB(1)/TRABUF(TNFRAC)
	    IF(LATEFLG) THEN
	       LSCLAT(LATCNT,GIND) = LSCLAT(LATCNT,GIND) + 1
	       LSCLAT(LATAMT,GIND) = LSCLAT(LATAMT,GIND) + WINTAB(1)
	    ENDIF
	  ENDIF
	ELSE
	  CALL SWIN_SWINLOS(TRABUF,WINTAB,WIN)
	ENDIF
C
C UPDATE VALIDATION RECORD
C
	IF(WIN.EQ.0) RETURN
	IF(V4BUF(VFSSER).NE.0) THEN
	  CALL LOGVAL(VALREC,V4BUF)
	  CALL DLOGVAL(VALREC,VDETAIL)
	ELSE
	  CALL FASTSET(0,VALREC,VALLEN)
	  CALL FASTSET(0,VDETAIL,VPLEN*VMAX)
	ENDIF
C
C
	DO 1000 I=1,WIN
	AMTWON=WINTAB(I)
	IF(REFUND) THEN
	  LSCREF(GIND)=LSCREF(GIND)+AMTWON
          LSCWRO(1,PRWON,GIND)=LSCWRO(1,PRWON,GIND) + 1
          LSCWRO(2,PRWON,GIND)=LSCWRO(2,PRWON,GIND) + AMTWON
          LSCWRA(1,PRWON,GIND)=LSCWRA(1,PRWON,GIND) + 1
          LSCWRA(2,PRWON,GIND)=LSCWRA(2,PRWON,GIND) + AMTWON
          LSCWON(GIND)=LSCWON(GIND)+AMTWON
          LSCWPR(1,PRWON,GIND)=LSCWPR(1,PRWON,GIND) + 1
          LSCWPR(2,PRWON,GIND)=LSCWPR(2,PRWON,GIND) + AMTWON
   	ENDIF
C
C
	VALREC(VPZOFF)=VALREC(VPZOFF)+1
	PRZIND=VALREC(VPZOFF)
	IF(PRZIND.GT.VMAX) THEN
	  TYPE*,IAM(),' Prize table overflow ',TRABUF(TCDC),TRABUF(TSER)
	  CALL GPAUSE
	  HLDFLG = .TRUE.
	  VALREC(VPZOFF)=VMAX
	  GOTO 20
	ENDIF
C
C
	VDETAIL(VKIK,PRZIND)=0
        VDETAIL(VKI2,PRZIND)=0
        VDETAIL(VPRG,PRZIND)=0
	VDETAIL(VREF,PRZIND)=0
	VDETAIL(VBDR,PRZIND)=0
	VDETAIL(VDIV,PRZIND)=0
	VDETAIL(VUPD,PRZIND)=1
	VDETAIL(VSHR,PRZIND)=AMTWON
	IF(REFUND) VDETAIL(VREF,PRZIND)=1
	VDETAIL(VDRW,PRZIND)=LSCDRW(GIND)
20	CONTINUE
	IF(REFUND) THEN
	  VALREC(VRAMT)=VALREC(VRAMT)+AMTWON
	ELSE
	  TOTWON=TOTWON+AMTWON
	ENDIF
1000	CONTINUE
C
C UPDATE VALIDATION HEADER IF NEW WINNER
C
	IF(VALREC(VSTAT).EQ.VNOWIN) THEN
	  VALREC(VSCDC)=TRABUF(TCDC)
	  VALREC(VSTER)=TRABUF(TTER)
	  VALREC(VSSER)=TRABUF(TSER)
	  VALREC(VEXP )=TRABUF(TWEND)
	  VALREC(VKEXP)=0
	  VALREC(VGAM )=TRABUF(TGAM)
	  VALREC(VKGME)=0
	  VALREC(VGTYP)=TRABUF(TGAMTYP)
	  VALREC(VGIND)=TRABUF(TGAMIND)
          VALREC(VFRAC)=TRABUF(TFRAC)
          VALREC(VBNKID)=TRABUF(TWBNKID)
          VALREC(VBNKNUM)=TRABUF(TWBNKNM)
	ENDIF
C
C GET TAXES AND SET PRIV PAY FLAG
C AND UPDATE BIG WINNER COMMISSION TABLE
C AND WINNERS COUNT AND AMOUNT
C
        IF(.NOT.CXLED.AND..NOT.REFUND) THEN
          LSCWON(GIND)=LSCWON(GIND)+TOTWON
          IF(TOTWON.GT.LSCHST(GIND)) LSCHST(GIND)=TOTWON
          DO 2000 I = 1,WIN
             AMTWON = WINTAB(I)
             IF(.NOT.REFUND) THEN
                LSCWPR(1,PRWON,GIND) = LSCWPR(1,PRWON,GIND) + 1
                LSCWPR(2,PRWON,GIND) = LSCWPR(2,PRWON,GIND) + AMTWON
                LSCWPO(1,PRWON,GIND) = LSCWPO(1,PRWON,GIND) + 1
                LSCWPO(2,PRWON,GIND) = LSCWPO(2,PRWON,GIND) + AMTWON
                CALL GETTAX(AMTWON,TAMT,NAMT)
                NETAMT = NETAMT + NAMT
                TAXAMT = TAXAMT + TAMT
             ENDIF
2000      CONTINUE
C***      CALL GETTAX(TOTWON,TAXAMT,NETAMT)
          IF(NETAMT.GT.REDMAX(TRABUF(TGAM))) PRVFLG=.TRUE.
          LSCTAX(GIND)=LSCTAX(GIND)+TAXAMT
          IF(HVCLVL.NE.0) THEN
            IF(NETAMT.GE.HVCLVL) THEN
              AWNTAB(1,TRABUF(TTER))=AWNTAB(1,TRABUF(TTER))+1
              AWNTAB(2,TRABUF(TTER))=AWNTAB(2,TRABUF(TTER))+NETAMT
            ENDIF
          ENDIF
          VALREC(VPAMT)=VALREC(VPAMT)+NETAMT
          VALREC(VTAMT)=VALREC(VTAMT)+TAXAMT
	ENDIF
C
C
        VALREC(VWCDC) = DAYCDC
	VALREC(VSTAT) = VUNCSH
        IF(PRVFLG) VALREC(VSTAT) = VPRPAY
	IF(HLDFLG) VALREC(VSTAT) = VHOLD
	IF(TRABUF(TSTAT).EQ.VOID) VALREC(VSTAT) = VCXL
	IF(TRABUF(TSTAT).EQ.INCA) VALREC(VSTAT) = VDEL
	CALL DVALLOG(VALREC,VDETAIL)
	CALL VALLOG (VALREC,V4BUF  )
	RETURN
	END
